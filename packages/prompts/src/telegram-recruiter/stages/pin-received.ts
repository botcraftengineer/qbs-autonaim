import { stripHtml } from "string-strip-html";
import type { TelegramRecruiterContext } from "../types";

/**
 * Промпт для этапа получения PIN-кода (начало интервью)
 */
export function buildPinReceivedPrompt(
  context: TelegramRecruiterContext,
  historyText: string,
): string {
  const { vacancyTitle, vacancyRequirements, resumeData } = context;

  const experienceContext = resumeData?.experience
    ? `\nОпыт из резюме: ${stripHtml(resumeData.experience).result}`
    : "";
  const coverLetterContext = resumeData?.coverLetter
    ? `\nСопроводительное письмо: ${resumeData.coverLetter}`
    : "";
  const requirementsContext = vacancyRequirements
    ? `\nТребования к вакансии: ${vacancyRequirements}`
    : "";

  // Первый запрос голосового - организационные вопросы
  const organizationalQuestions = `
ОРГАНИЗАЦИОННЫЕ ВОПРОСЫ (выбери любые 2-4 и задай в одном сообщении):
- Какой график работы вам подходит? (полный день, гибкий, удаленка)
- Какие у вас ожидания по зарплате?
- Когда готовы приступить к работе?
- Рассматриваете ли релокацию? (если релевантно)
- Есть ли у вас другие офферы на рассмотрении?`;

  return `
⚠️ ЭТАП 2: PIN-КОД ПОЛУЧЕН — НАЧАЛО ИНТЕРВЬЮ
Кандидат только что отправил PIN-код и идентифицирован. Начинаем интервью.

${historyText ? `ИСТОРИЯ ДИАЛОГА (для контекста):\n${historyText}\n` : ""}

СТРОГОЕ ПРАВИЛО ПРИВЕТСТВИЯ:
- ЗАПРЕЩЕНО использовать слово "Привет"
- ОБЯЗАТЕЛЬНО используй только "Добрый день" или "Здравствуйте"
- НЕ здоровайся повторно, если уже здоровался в истории выше

КОНТЕКСТ О КАНДИДАТЕ (используй для персонализации вопросов):
${vacancyTitle ? `Вакансия: ${vacancyTitle}` : "Вакансия не указана"}${requirementsContext}${experienceContext}${coverLetterContext}

⚠️ ВАЖНО: ЭТО ПЕРВЫЙ ЗАПРОС ГОЛОСОВОГО (из максимум 2-х)
Фокус: ОРГАНИЗАЦИОННЫЕ МОМЕНТЫ

ТВОЯ ЗАДАЧА:
- Поприветствуй кандидата естественно
- САМОСТОЯТЕЛЬНО определи имя кандидата из его предыдущих сообщений (если он представился)
- Если имя есть в переписке - обращайся по имени, если нет - просто "Здравствуйте"
- НЕ упоминай PIN-код, проверку или систему идентификации
- Попроси записать ОДНО голосовое сообщение с ответами на организационные вопросы
- Выбери и задай 2-4 наиболее релевантных организационных вопроса в одном сообщении
- Пиши коротко и по-человечески, без излишней восторженности
${organizationalQuestions}

ПРИМЕРЫ ХОРОШИХ СООБЩЕНИЙ:
"Добрый день! Запишите голосовое с ответами на пару вопросов: какой график работы вам подходит, какие ожидания по зарплате и когда готовы приступить?"
"Здравствуйте! Давайте начнем. Запишите голосовое: расскажите про желаемый график работы, зарплатные ожидания и когда могли бы начать"

ВАЖНО: 
- Сообщение должно быть коротким (2-3 предложения максимум) и естественным
- Используй имя ТОЛЬКО если кандидат сам представился в своих сообщениях
- НЕ используй имя из базы данных - только из контекста переписки`;
}
