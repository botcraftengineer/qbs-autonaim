import { stripHtml } from "string-strip-html";
import { sanitizeUserInput } from "../../utils/sanitize";
import type { TelegramRecruiterContext } from "../types";

/**
 * –ü—Ä–æ–º–ø—Ç –¥–ª—è —ç—Ç–∞–ø–∞ –ø–æ–ª—É—á–µ–Ω–∏—è PIN-–∫–æ–¥–∞ (–Ω–∞—á–∞–ª–æ –∏–Ω—Ç–µ—Ä–≤—å—é)
 */
export function buildPinReceivedPrompt(
  context: TelegramRecruiterContext,
  historyText: string,
  alreadyGreeted = false,
): string {
  const {
    vacancyTitle,
    vacancyRequirements,
    resumeData,
    customOrganizationalQuestions,
    screeningScore,
    screeningAnalysis,
  } = context;

  const greetingInstruction = alreadyGreeted
    ? "- ‚ö†Ô∏è –¢–´ –£–ñ–ï –ó–î–û–†–û–í–ê–õ–°–Ø - –ù–ï –ó–î–û–†–û–í–ê–ô–°–Ø –°–ù–û–í–ê!\n"
    : "";

  const experienceContext = resumeData?.experience
    ? `\n–û–ø—ã—Ç –∏–∑ —Ä–µ–∑—é–º–µ: ${stripHtml(resumeData.experience).result}`
    : "";
  const coverLetterContext = resumeData?.coverLetter
    ? `\n–°–æ–ø—Ä–æ–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ–µ –ø–∏—Å—å–º–æ: ${resumeData.coverLetter}`
    : "";
  const requirementsContext = vacancyRequirements
    ? `\n–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ –≤–∞–∫–∞–Ω—Å–∏–∏: ${vacancyRequirements}`
    : "";

  // –ö–æ–Ω—Ç–µ–∫—Å—Ç —Å–∫—Ä–∏–Ω–∏–Ω–≥–∞
  const screeningContext =
    screeningScore !== undefined
      ? `\n–†–µ–∑—É–ª—å—Ç–∞—Ç —Å–∫—Ä–∏–Ω–∏–Ω–≥–∞: ${screeningScore}/5${screeningAnalysis ? ` ‚Äî ${screeningAnalysis}` : ""}`
      : "";

  // –û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–æ–Ω–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã - –∫–∞—Å—Ç–æ–º–Ω—ã–µ –∏–ª–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
  const defaultOrgQuestions = `
–û–†–ì–ê–ù–ò–ó–ê–¶–ò–û–ù–ù–´–ï –í–û–ü–†–û–°–´ (–≤—ã–±–µ—Ä–∏ –ª—é–±—ã–µ 2-4 –∏ –∑–∞–¥–∞–π –≤ –æ–¥–Ω–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏):
- –ö–∞–∫–æ–π –≥—Ä–∞—Ñ–∏–∫ —Ä–∞–±–æ—Ç—ã –≤–∞–º –ø–æ–¥—Ö–æ–¥–∏—Ç? (–ø–æ–ª–Ω—ã–π –¥–µ–Ω—å, –≥–∏–±–∫–∏–π, —É–¥–∞–ª–µ–Ω–∫–∞)
- –ö–∞–∫–∏–µ —É –≤–∞—Å –æ–∂–∏–¥–∞–Ω–∏—è –ø–æ –∑–∞—Ä–ø–ª–∞—Ç–µ?
- –ö–æ–≥–¥–∞ –≥–æ—Ç–æ–≤—ã –ø—Ä–∏—Å—Ç—É–ø–∏—Ç—å –∫ —Ä–∞–±–æ—Ç–µ?
- –†–∞—Å—Å–º–∞—Ç—Ä–∏–≤–∞–µ—Ç–µ –ª–∏ —Ä–µ–ª–æ–∫–∞—Ü–∏—é? (–µ—Å–ª–∏ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ)
- –ï—Å—Ç—å –ª–∏ —É –≤–∞—Å –¥—Ä—É–≥–∏–µ –æ—Ñ—Ñ–µ—Ä—ã –Ω–∞ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–∏?`;

  const organizationalQuestions = customOrganizationalQuestions
    ? `
–û–†–ì–ê–ù–ò–ó–ê–¶–ò–û–ù–ù–´–ï –í–û–ü–†–û–°–´ (–≤—ã–±–µ—Ä–∏ 2-4 –∏–∑ —Å–ø–∏—Å–∫–∞ –Ω–∏–∂–µ):
${sanitizeUserInput(customOrganizationalQuestions)}`
    : defaultOrgQuestions;

  return `
‚ö†Ô∏è –≠–¢–ê–ü 2: PIN-–ö–û–î –ü–û–õ–£–ß–ï–ù ‚Äî –ù–ê–ß–ê–õ–û –ò–ù–¢–ï–†–í–¨–Æ
–ö–∞–Ω–¥–∏–¥–∞—Ç —Ç–æ–ª—å–∫–æ —á—Ç–æ –æ—Ç–ø—Ä–∞–≤–∏–ª PIN-–∫–æ–¥ –∏ –∏–¥–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω. –ù–∞—á–∏–Ω–∞–µ–º –∏–Ω—Ç–µ—Ä–≤—å—é.

–°–¢–†–£–ö–¢–£–†–ê –ò–ù–¢–ï–†–í–¨–Æ (–≤—Å–µ–≥–æ 2 –≥–æ–ª–æ—Å–æ–≤—ã—Ö):
1Ô∏è‚É£ –ü–ï–†–í–û–ï –ì–û–õ–û–°–û–í–û–ï (—Å–µ–π—á–∞—Å) - –û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–æ–Ω–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã
2Ô∏è‚É£ –í–¢–û–†–û–ï –ì–û–õ–û–°–û–í–û–ï (–ø–æ—Ç–æ–º) - –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ/–ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã

${historyText ? `–ò–°–¢–û–†–ò–Ø –î–ò–ê–õ–û–ì–ê (–¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞):\n${historyText}\n` : ""}

–°–¢–†–û–ì–û–ï –ü–†–ê–í–ò–õ–û –ü–†–ò–í–ï–¢–°–¢–í–ò–Ø:
- –ó–ê–ü–†–ï–©–ï–ù–û –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å–ª–æ–≤–æ "–ü—Ä–∏–≤–µ—Ç"
- –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –∏—Å–ø–æ–ª—å–∑—É–π —Ç–æ–ª—å–∫–æ "–î–æ–±—Ä—ã–π –¥–µ–Ω—å" –∏–ª–∏ "–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ"
${greetingInstruction}
–ö–û–ù–¢–ï–ö–°–¢ –û –ö–ê–ù–î–ò–î–ê–¢–ï (–∏—Å–ø–æ–ª—å–∑—É–π –¥–ª—è –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏–∏ –≤–æ–ø—Ä–æ—Å–æ–≤):
${vacancyTitle ? `–í–∞–∫–∞–Ω—Å–∏—è: ${vacancyTitle}` : "–í–∞–∫–∞–Ω—Å–∏—è –Ω–µ —É–∫–∞–∑–∞–Ω–∞"}${requirementsContext}${experienceContext}${coverLetterContext}${screeningContext}

‚ö†Ô∏è –≠–¢–ê–ü 1/2: –û–†–ì–ê–ù–ò–ó–ê–¶–ò–û–ù–ù–´–ï –í–û–ü–†–û–°–´
–ü–æ–ø—Ä–æ—Å–∏ –∑–∞–ø–∏—Å–∞—Ç—å –û–î–ù–û –≥–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –æ—Ç–≤–µ—Ç–∞–º–∏ –Ω–∞ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–æ–Ω–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã.

${organizationalQuestions}

‚ö†Ô∏è –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û - –ü–†–û–í–ï–†–¨ –ò–°–¢–û–†–ò–Æ –ü–ï–†–ï–î –û–¢–í–ï–¢–û–ú:

–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –ø–æ—Å–º–æ—Ç—Ä–∏ –Ω–∞ –ò–°–¢–û–†–ò–Æ –î–ò–ê–õ–û–ì–ê –≤—ã—à–µ!

–ï—Å–ª–∏ –≤ –∏—Å—Ç–æ—Ä–∏–∏ –≤–∏–¥–Ω–æ, —á—Ç–æ —Ç—ã –£–ñ–ï –∑–∞–¥–∞–ª –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–æ–Ω–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã –≤ –ø—Ä–µ–¥—ã–¥—É—â–µ–º —Å–æ–æ–±—â–µ–Ω–∏–∏, –∞ –∫–∞–Ω–¥–∏–¥–∞—Ç —Å–µ–π—á–∞—Å –ø—Ä–∏—Å–ª–∞–ª:
- –ü—Ä–æ—Å—Ç–æ–µ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ: "–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ", "–ü—Ä–∏–≤–µ—Ç", "–î–æ–±—Ä—ã–π –¥–µ–Ω—å"
- –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ: "–û–∫", "–•–æ—Ä–æ—à–æ", "–ü–æ–Ω—è—Ç–Ω–æ", "–î–∞"
- –≠–º–æ–¥–∑–∏ –±–µ–∑ —Ç–µ–∫—Å—Ç–∞: "üëç", "üôè", "üëå"

–¢–æ –≤–µ—Ä–Ω–∏ –¢–û–õ–¨–ö–û —Ç–µ–∫—Å—Ç: [SKIP]

–õ–û–ì–ò–ö–ê: –ö–∞–Ω–¥–∏–¥–∞—Ç –ø—Ä–æ—Å—Ç–æ –ø–æ–∑–¥–æ—Ä–æ–≤–∞–ª—Å—è –≤ –æ—Ç–≤–µ—Ç, –Ω–æ –µ—â–µ –Ω–µ –¥–∞–ª –æ—Ç–≤–µ—Ç—ã –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã.
–ù–ï –Ω—É–∂–Ω–æ –æ—Ç–≤–µ—á–∞—Ç—å –Ω–∞ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ - –ø—Ä–æ—Å—Ç–æ –∂–¥–∏ –µ–≥–æ –≥–æ–ª–æ—Å–æ–≤–æ–µ/—Ç–µ–∫—Å—Ç–æ–≤—ã–µ –æ—Ç–≤–µ—Ç—ã.

–ü–†–û–í–ï–†–ö–ê: –ü–æ—Å–º–æ—Ç—Ä–∏ –≤ –∏—Å—Ç–æ—Ä–∏–∏ - –µ—Å—Ç—å –ª–∏ —Ç–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –≤–æ–ø—Ä–æ—Å–∞–º–∏? –ï—Å–ª–∏ –¥–∞ –∏ –∫–∞–Ω–¥–∏–¥–∞—Ç –ø—Ä–∏—Å–ª–∞–ª —Ç–æ–ª—å–∫–æ "–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ" - –≤–µ—Ä–Ω–∏ [SKIP].

–¢–í–û–Ø –ó–ê–î–ê–ß–ê:
${alreadyGreeted ? "- –ù–µ –∑–¥–æ—Ä–æ–≤–∞–π—Å—è –∑–∞–Ω–æ–≤–æ!" : "- –ü–æ–ø—Ä–∏–≤–µ—Ç—Å—Ç–≤—É–π –∫–∞–Ω–¥–∏–¥–∞—Ç–∞ –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ"}
- –°–ê–ú–û–°–¢–û–Ø–¢–ï–õ–¨–ù–û –æ–ø—Ä–µ–¥–µ–ª–∏ –∏–º—è –∫–∞–Ω–¥–∏–¥–∞—Ç–∞ –∏–∑ –µ–≥–æ –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π (–µ—Å–ª–∏ –æ–Ω –ø—Ä–µ–¥—Å—Ç–∞–≤–∏–ª—Å—è)
- –ï—Å–ª–∏ –∏–º—è –µ—Å—Ç—å –≤ –ø–µ—Ä–µ–ø–∏—Å–∫–µ - –æ–±—Ä–∞—â–∞–π—Å—è –ø–æ –∏–º–µ–Ω–∏, –µ—Å–ª–∏ –Ω–µ—Ç - –ø—Ä–æ—Å—Ç–æ "–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ"
- –ù–ï —É–ø–æ–º–∏–Ω–∞–π PIN-–∫–æ–¥, –ø—Ä–æ–≤–µ—Ä–∫—É –∏–ª–∏ —Å–∏—Å—Ç–µ–º—É –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
- –í—ã–±–µ—Ä–∏ 2-4 —Å–∞–º—ã—Ö —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã—Ö –≤–æ–ø—Ä–æ—Å–∞ –∏–∑ —Å–ø–∏—Å–∫–∞ –≤—ã—à–µ
- –ó–∞–¥–∞–π –∏—Ö –í–°–ï –í –û–î–ù–û–ú —Å–æ–æ–±—â–µ–Ω–∏–∏ (–Ω–µ —Ä–∞—Å—Ç—è–≥–∏–≤–∞–π –Ω–∞ –Ω–µ—Å–∫–æ–ª—å–∫–æ)
- –ë—É–¥—å –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –∫—Ä–∞—Ç–æ–∫: 2-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è
- –ï—Å–ª–∏ –∫–∞–Ω–¥–∏–¥–∞—Ç –Ω–µ —Ö–æ—á–µ—Ç –≥–æ–ª–æ—Å–æ–≤–æ–µ - –ø—Ä–∏–Ω–∏–º–∞–π —Ç–µ–∫—Å—Ç–æ–≤—ã–µ –æ—Ç–≤–µ—Ç—ã
- ‚ö†Ô∏è –ü–æ—Å–ª–µ —Ç–æ–≥–æ –∫–∞–∫ –∑–∞–¥–∞–ª –≤–æ–ø—Ä–æ—Å—ã - –ù–ï –æ—Ç–≤–µ—á–∞–π –Ω–∞ –ø—Ä–æ—Å—Ç–æ–µ "–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ" (–≤–µ—Ä–Ω–∏ [SKIP])

–ü–†–ò–ú–ï–†–´ –•–û–†–û–®–ò–• –û–¢–í–ï–¢–û–í:
- "–î–æ–±—Ä—ã–π –¥–µ–Ω—å! –ó–∞–ø–∏—à–∏—Ç–µ –≥–æ–ª–æ—Å–æ–≤–æ–µ —Å –æ—Ç–≤–µ—Ç–∞–º–∏ –Ω–∞ –ø–∞—Ä—É –≤–æ–ø—Ä–æ—Å–æ–≤: –∫–∞–∫–æ–π –≥—Ä–∞—Ñ–∏–∫ —Ä–∞–±–æ—Ç—ã –≤–∞–º –ø–æ–¥—Ö–æ–¥–∏—Ç, –∫–∞–∫–∏–µ –æ–∂–∏–¥–∞–Ω–∏—è –ø–æ –∑–∞—Ä–ø–ª–∞—Ç–µ –∏ –∫–æ–≥–¥–∞ –≥–æ—Ç–æ–≤—ã –ø—Ä–∏—Å—Ç—É–ø–∏—Ç—å?"
- "–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –î–∞–≤–∞–π—Ç–µ –Ω–∞—á–Ω–µ–º. –ó–∞–ø–∏—à–∏—Ç–µ –≥–æ–ª–æ—Å–æ–≤–æ–µ: —Ä–∞—Å—Å–∫–∞–∂–∏—Ç–µ –ø—Ä–æ –∂–µ–ª–∞–µ–º—ã–π –≥—Ä–∞—Ñ–∏–∫ —Ä–∞–±–æ—Ç—ã, –∑–∞—Ä–ø–ª–∞—Ç–Ω—ã–µ –æ–∂–∏–¥–∞–Ω–∏—è –∏ –∫–æ–≥–¥–∞ –º–æ–≥–ª–∏ –±—ã –Ω–∞—á–∞—Ç—å"
- –ï—Å–ª–∏ –∫–∞–Ω–¥–∏–¥–∞—Ç –Ω–µ —Ö–æ—á–µ—Ç: "–ú–æ–∂–µ—Ç–µ –æ—Ç–≤–µ—Ç–∏—Ç—å —Ç–µ–∫—Å—Ç–æ–º, –Ω–æ –≥–æ–ª–æ—Å–æ–º –±—ã—Å—Ç—Ä–µ–µ üôÇ"
- –ï—Å–ª–∏ –ø—Ä–æ—Å–∏—Ç –æ—Ç–ª–æ–∂–∏—Ç—å: "–•–æ—Ä–æ—à–æ, –∂–¥—É –≤–∞—à–∏—Ö –æ—Ç–≤–µ—Ç–æ–≤. –ù–∞–ø–∏—à–∏—Ç–µ, –∫–æ–≥–¥–∞ –±—É–¥–µ—Ç–µ –≥–æ—Ç–æ–≤—ã üôÇ"`;
}
