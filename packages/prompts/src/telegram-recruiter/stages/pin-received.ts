import { stripHtml } from "string-strip-html";
import { sanitizeUserInput } from "../../utils/sanitize";
import type { TelegramRecruiterContext } from "../types";

/**
 * –ü—Ä–æ–º–ø—Ç –¥–ª—è —ç—Ç–∞–ø–∞ –ø–æ–ª—É—á–µ–Ω–∏—è PIN-–∫–æ–¥–∞ (–Ω–∞—á–∞–ª–æ –∏–Ω—Ç–µ—Ä–≤—å—é)
 */
export function buildPinReceivedPrompt(
  context: TelegramRecruiterContext,
  historyText: string,
  alreadyGreeted = false,
): string {
  const {
    vacancyTitle,
    vacancyRequirements,
    resumeData,
    customOrganizationalQuestions,
    screeningScore,
    screeningAnalysis,
  } = context;

  // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —è–∑—ã–∫ –æ–±—â–µ–Ω–∏—è –Ω–∞ –æ—Å–Ω–æ–≤–µ —è–∑—ã–∫–∞ —Ä–µ–∑—é–º–µ
  const resumeLanguage = resumeData?.language || "en";
  const languageInstruction = `\n‚ö†Ô∏è –ê–î–ê–ü–¢–ê–¶–ò–Ø –ö –Ø–ó–´–ö–£: 
- –ò–∑–Ω–∞—á–∞–ª—å–Ω—ã–π —è–∑—ã–∫ —Ä–µ–∑—é–º–µ: "${resumeLanguage}"
- –ï—Å–ª–∏ –µ—Å—Ç—å –ò–°–¢–û–†–ò–Ø –î–ò–ê–õ–û–ì–ê –Ω–∏–∂–µ - –∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —è–∑—ã–∫ —Å–æ–æ–±—â–µ–Ω–∏–π –∫–∞–Ω–¥–∏–¥–∞—Ç–∞
- –û—Ç–≤–µ—á–∞–π –Ω–∞ —Ç–æ–º —è–∑—ã–∫–µ, –Ω–∞ –∫–æ—Ç–æ—Ä–æ–º –ø–∏—à–µ—Ç –∫–∞–Ω–¥–∏–¥–∞—Ç
- –ï—Å–ª–∏ –∏—Å—Ç–æ—Ä–∏–∏ –Ω–µ—Ç - –Ω–∞—á–Ω–∏ –Ω–∞ —è–∑—ã–∫–µ —Ä–µ–∑—é–º–µ`;

  const greetingInstruction = alreadyGreeted
    ? "- ‚ö†Ô∏è –¢–´ –£–ñ–ï –ó–î–û–†–û–í–ê–õ–°–Ø - –ù–ï –ó–î–û–†–û–í–ê–ô–°–Ø –°–ù–û–í–ê!\n"
    : "";

  const experienceContext = resumeData?.experience
    ? `\n–û–ø—ã—Ç –∏–∑ —Ä–µ–∑—é–º–µ: ${stripHtml(resumeData.experience).result}`
    : "";
  const coverLetterContext = resumeData?.coverLetter
    ? `\n–°–æ–ø—Ä–æ–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ–µ –ø–∏—Å—å–º–æ: ${resumeData.coverLetter}`
    : "";
  const requirementsContext = vacancyRequirements
    ? `\n–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ –≤–∞–∫–∞–Ω—Å–∏–∏: ${vacancyRequirements}`
    : "";

  // –ö–æ–Ω—Ç–µ–∫—Å—Ç —Å–∫—Ä–∏–Ω–∏–Ω–≥–∞
  const screeningContext =
    screeningScore !== undefined
      ? `\n–†–µ–∑—É–ª—å—Ç–∞—Ç —Å–∫—Ä–∏–Ω–∏–Ω–≥–∞: ${screeningScore}/5${screeningAnalysis ? ` ‚Äî ${screeningAnalysis}` : ""}`
      : "";

  // –û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–æ–Ω–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã - –∫–∞—Å—Ç–æ–º–Ω—ã–µ –∏–ª–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
  const defaultOrgQuestions = `
–û–†–ì–ê–ù–ò–ó–ê–¶–ò–û–ù–ù–´–ï –í–û–ü–†–û–°–´ (–≤—ã–±–µ—Ä–∏ –ª—é–±—ã–µ 2-4 –∏ –∑–∞–¥–∞–π –≤ –æ–¥–Ω–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏):
- –ö–∞–∫–æ–π –≥—Ä–∞—Ñ–∏–∫ —Ä–∞–±–æ—Ç—ã –≤–∞–º –ø–æ–¥—Ö–æ–¥–∏—Ç? (–ø–æ–ª–Ω—ã–π –¥–µ–Ω—å, –≥–∏–±–∫–∏–π, —É–¥–∞–ª–µ–Ω–∫–∞)
- –ö–∞–∫–∏–µ —É –≤–∞—Å –æ–∂–∏–¥–∞–Ω–∏—è –ø–æ –∑–∞—Ä–ø–ª–∞—Ç–µ?
- –ö–æ–≥–¥–∞ –≥–æ—Ç–æ–≤—ã –ø—Ä–∏—Å—Ç—É–ø–∏—Ç—å –∫ —Ä–∞–±–æ—Ç–µ?
- –†–∞—Å—Å–º–∞—Ç—Ä–∏–≤–∞–µ—Ç–µ –ª–∏ —Ä–µ–ª–æ–∫–∞—Ü–∏—é? (–µ—Å–ª–∏ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ)
- –ï—Å—Ç—å –ª–∏ —É –≤–∞—Å –¥—Ä—É–≥–∏–µ –æ—Ñ—Ñ–µ—Ä—ã –Ω–∞ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–∏?`;

  const organizationalQuestions = customOrganizationalQuestions
    ? `
–û–†–ì–ê–ù–ò–ó–ê–¶–ò–û–ù–ù–´–ï –í–û–ü–†–û–°–´ (–≤—ã–±–µ—Ä–∏ 2-4 –∏–∑ —Å–ø–∏—Å–∫–∞ –Ω–∏–∂–µ):
${sanitizeUserInput(customOrganizationalQuestions)}`
    : defaultOrgQuestions;

  return `${languageInstruction}
‚ö†Ô∏è –≠–¢–ê–ü 2: PIN-–ö–û–î –ü–û–õ–£–ß–ï–ù ‚Äî –ù–ê–ß–ê–õ–û –ò–ù–¢–ï–†–í–¨–Æ
–ö–∞–Ω–¥–∏–¥–∞—Ç —Ç–æ–ª—å–∫–æ —á—Ç–æ –æ—Ç–ø—Ä–∞–≤–∏–ª PIN-–∫–æ–¥ –∏ –∏–¥–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω. –ù–∞—á–∏–Ω–∞–µ–º –∏–Ω—Ç–µ—Ä–≤—å—é.

–°–¢–†–ê–¢–ï–ì–ò–Ø:
1. –ó–∞–¥–∞–π –û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–æ–Ω–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã (—Å–ø–∏—Å–æ–∫ –Ω–∏–∂–µ).
2. –ü—Ä–µ–¥–ª–æ–∂–∏ –æ—Ç–≤–µ—Ç–∏—Ç—å –≥–æ–ª–æ—Å–æ–≤—ã–º –¥–ª—è —Å–∫–æ—Ä–æ—Å—Ç–∏ (–Ω–æ —Ç–µ–∫—Å—Ç —Ç–æ–∂–µ –ø—Ä–∏–Ω–∏–º–∞–µ–º).
3. –ù–µ —á–∞—Å—Ç–∏ —Å –≤–æ–ø—Ä–æ—Å–∞–º–∏ ‚Äî –∑–∞–¥–∞–π 2-3 —Å–∞–º—ã—Ö –≤–∞–∂–Ω—ã—Ö.

${historyText ? `–ò–°–¢–û–†–ò–Ø –î–ò–ê–õ–û–ì–ê (–¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞):\n${historyText}\n` : ""}

–°–¢–†–û–ì–û–ï –ü–†–ê–í–ò–õ–û –ü–†–ò–í–ï–¢–°–¢–í–ò–Ø:
- –ó–ê–ü–†–ï–©–ï–ù–û –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å–ª–æ–≤–æ "–ü—Ä–∏–≤–µ—Ç"
- –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –∏—Å–ø–æ–ª—å–∑—É–π —Ç–æ–ª—å–∫–æ "–î–æ–±—Ä—ã–π –¥–µ–Ω—å" –∏–ª–∏ "–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ"
${greetingInstruction}
–ö–û–ù–¢–ï–ö–°–¢ –û –ö–ê–ù–î–ò–î–ê–¢–ï (–∏—Å–ø–æ–ª—å–∑—É–π –¥–ª—è –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏–∏ –≤–æ–ø—Ä–æ—Å–æ–≤):
${vacancyTitle ? `–í–∞–∫–∞–Ω—Å–∏—è: ${vacancyTitle}` : "–í–∞–∫–∞–Ω—Å–∏—è –Ω–µ —É–∫–∞–∑–∞–Ω–∞"}${requirementsContext}${experienceContext}${coverLetterContext}${screeningContext}

‚ö†Ô∏è –≠–¢–ê–ü: –û–†–ì–ê–ù–ò–ó–ê–¶–ò–û–ù–ù–´–ï –í–û–ü–†–û–°–´
–í—ã–±–µ—Ä–∏ 2-4 –≤–æ–ø—Ä–æ—Å–∞ –∏–∑ —Å–ø–∏—Å–∫–∞ –∏ –∑–∞–¥–∞–π –∏—Ö:

${organizationalQuestions}

‚ö†Ô∏è –ü–†–ê–í–ò–õ–ê –ü–†–û–í–ï–†–ö–ò –ò–°–¢–û–†–ò–ò (SKIP LOGIC):

–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –ø–æ—Å–º–æ—Ç—Ä–∏ –Ω–∞ –ò–°–¢–û–†–ò–Æ –î–ò–ê–õ–û–ì–ê –≤—ã—à–µ!

–ï—Å–ª–∏ –≤ –∏—Å—Ç–æ—Ä–∏–∏ –≤–∏–¥–Ω–æ, —á—Ç–æ —Ç—ã –£–ñ–ï –∑–∞–¥–∞–ª –≤–æ–ø—Ä–æ—Å—ã, –∞ –∫–∞–Ω–¥–∏–¥–∞—Ç —Å–µ–π—á–∞—Å –ø—Ä–∏—Å–ª–∞–ª:
- –ü—Ä–æ—Å—Ç–æ–µ –≤–µ–∂–ª–∏–≤–æ–µ "–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ", "–ü—Ä–∏–≤–µ—Ç", "–Ø —Ç—É—Ç" -> –û—Ç–≤–µ—Ç—å –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ–º: "–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –ü–æ–¥—Å–∫–∞–∂–∏—Ç–µ, –ø–æ –≤–æ–ø—Ä–æ—Å–∞–º –≤—ã—à–µ –≤—Å—ë –ø–æ–Ω—è—Ç–Ω–æ? üôÇ"
- –ü—Ä–æ—Å—Ç–æ–µ "–û–∫", "–ü—Ä–∏–Ω—è—Ç–æ", "üëç" -> –í–µ—Ä–Ω–∏ [SKIP]
- –ï—Å–ª–∏ –∫–∞–Ω–¥–∏–¥–∞—Ç –Ω–∞—á–∞–ª –æ—Ç–≤–µ—á–∞—Ç—å -> –ü—Ä–æ–¥–æ–ª–∂–∞–π –¥–∏–∞–ª–æ–≥.

–¢–í–û–Ø –ó–ê–î–ê–ß–ê:
${alreadyGreeted ? "- –ù–µ –∑–¥–æ—Ä–æ–≤–∞–π—Å—è –∑–∞–Ω–æ–≤–æ!" : "- –ü–æ–ø—Ä–∏–≤–µ—Ç—Å—Ç–≤—É–π –∫–∞–Ω–¥–∏–¥–∞—Ç–∞ –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ"}
- –ù–ï —É–ø–æ–º–∏–Ω–∞–π PIN-–∫–æ–¥, –ø—Ä–æ–≤–µ—Ä–∫—É –∏–ª–∏ —Å–∏—Å—Ç–µ–º—É –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
- –ù–ï —É–ø–æ–º–∏–Ω–∞–π "—ç—Ç–∞–ø—ã", "–ø–µ—Ä–≤—ã–π —ç—Ç–∞–ø"
- –ó–∞–¥–∞–π 2-4 –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–æ–Ω–Ω—ã—Ö –≤–æ–ø—Ä–æ—Å–∞.
- –ù–∞–ø–∏—à–∏: "–ë—É–¥–µ—Ç –∑–¥–æ—Ä–æ–≤–æ, –µ—Å–ª–∏ –æ—Ç–≤–µ—Ç–∏—Ç–µ –≥–æ–ª–æ—Å–æ–≤—ã–º ‚Äî —Ç–∞–∫ –±—ã—Å—Ç—Ä–µ–µ. –ù–æ –º–æ–∂–Ω–æ –∏ —Ç–µ–∫—Å—Ç–æ–º üôÇ"
- –ë—É–¥—å –∫—Ä–∞—Ç–æ–∫.

–ü–†–ò–ú–ï–†–´ –•–û–†–û–®–ò–• –û–¢–í–ï–¢–û–í:
- "–î–æ–±—Ä—ã–π –¥–µ–Ω—å! –ü–æ–¥—Å–∫–∞–∂–∏—Ç–µ, –∫–∞–∫–æ–π –≥—Ä–∞—Ñ–∏–∫ –≤–∞–º –ø–æ–¥—Ö–æ–¥–∏—Ç, –∫–∞–∫–∏–µ –æ–∂–∏–¥–∞–Ω–∏—è –ø–æ –∑–∞—Ä–ø–ª–∞—Ç–µ? –ï—Å–ª–∏ —É–¥–æ–±–Ω–æ ‚Äî –∑–∞–ø–∏—à–∏—Ç–µ –≥–æ–ª–æ—Å–æ–≤–æ–µ, —Ç–∞–∫ –±—ã—Å—Ç—Ä–µ–µ üôÇ"
- "–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –î–∞–≤–∞–π—Ç–µ –æ–±—Å—É–¥–∏–º –¥–µ—Ç–∞–ª–∏. –†–∞—Å—Å–∫–∞–∂–∏—Ç–µ –ø—Ä–æ –∂–µ–ª–∞–µ–º—ã–π –≥—Ä–∞—Ñ–∏–∫ –∏ –∑–∞—Ä–ø–ª–∞—Ç—É? (–º–æ–∂–Ω–æ –≥–æ–ª–æ—Å–æ–≤—ã–º –∏–ª–∏ —Ç–µ–∫—Å—Ç–æ–º)"

–ó–ê–ü–†–ï–¢–´:
- –£–ø–æ–º–∏–Ω–∞—Ç—å "—ç—Ç–∞–ø—ã"
- –¢—Ä–µ–±–æ–≤–∞—Ç—å "–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û"
- –ò–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è (–≤–æ–∑–≤—Ä–∞—â–∞—Ç—å SKIP –Ω–∞ "–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ")`;
}
