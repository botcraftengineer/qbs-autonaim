/**
 * –ü—Ä–æ–º–ø—Ç—ã –¥–ª—è Telegram-–±–æ—Ç–∞ —Ä–µ–∫—Ä—É—Ç–µ—Ä–∞
 *
 * –ê–†–•–ò–¢–ï–ö–¢–£–†–ê:
 * –°–∏—Å—Ç–µ–º–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ 3 —ç—Ç–∞–ø–∞ —Å —á–µ—Ç–∫–æ–π –ª–æ–≥–∏–∫–æ–π –ø–µ—Ä–µ—Ö–æ–¥–∞ –º–µ–∂–¥—É –Ω–∏–º–∏:
 *
 * 1. AWAITING_PIN (–û–∂–∏–¥–∞–Ω–∏–µ PIN-–∫–æ–¥–∞)
 *    - –ö–∞–Ω–¥–∏–¥–∞—Ç –Ω–µ –∏–¥–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω
 *    - AI –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç 4-–∑–Ω–∞—á–Ω—ã–π –∫–æ–¥ –∏–∑ –ø–∏—Å—å–º–∞
 *    - –ü–µ—Ä–µ—Ö–æ–¥: –∫–æ–≥–¥–∞ –∫–∞–Ω–¥–∏–¥–∞—Ç –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç PIN ‚Üí —Å–∏—Å—Ç–µ–º–∞ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç ‚Üí —Å–æ–∑–¥–∞–µ—Ç conversation ‚Üí –ø–µ—Ä–µ—Ö–æ–¥ –∫ PIN_RECEIVED
 *
 * 2. PIN_RECEIVED (PIN –ø–æ–ª—É—á–µ–Ω - –Ω–∞—á–∞–ª–æ –∏–Ω—Ç–µ—Ä–≤—å—é)
 *    - –ö–∞–Ω–¥–∏–¥–∞—Ç —Ç–æ–ª—å–∫–æ —á—Ç–æ –∏–¥–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω –ø–æ PIN
 *    - AI –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –∏ —Å—Ä–∞–∑—É –ø—Ä–æ—Å–∏—Ç –≥–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
 *    - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –¥–∞–Ω–Ω—ã–µ –∏–∑ —Ä–µ–∑—é–º–µ –¥–ª—è –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏–∏ –≤–æ–ø—Ä–æ—Å–æ–≤
 *    - –ü–µ—Ä–µ—Ö–æ–¥: –ø–æ—Å–ª–µ –ø–µ—Ä–≤–æ–≥–æ –æ—Ç–≤–µ—Ç–∞ ‚Üí INTERVIEWING
 *
 * 3. INTERVIEWING (–ü—Ä–æ–≤–µ–¥–µ–Ω–∏–µ –∏–Ω—Ç–µ—Ä–≤—å—é)
 *    - –ü–æ–ª–Ω–æ—Ü–µ–Ω–Ω–æ–µ –∏–Ω—Ç–µ—Ä–≤—å—é —Å –∏–¥–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–º –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–º
 *    - AI –∑–∞–¥–∞–µ—Ç –≤–æ–ø—Ä–æ—Å—ã, —Å–æ–±–∏—Ä–∞–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é, –ø—Ä–µ–¥–ª–∞–≥–∞–µ—Ç —Å–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏
 *    - –ï—Å–ª–∏ –Ω–µ—Ç –≥–æ–ª–æ—Å–æ–≤—ã—Ö - –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω–æ –ø—Ä–æ—Å–∏—Ç –∑–∞–ø–∏—Å–∞—Ç—å
 *    - –ï—Å–ª–∏ –µ—Å—Ç—å –≥–æ–ª–æ—Å–æ–≤—ã–µ - –∑–∞–¥–∞–µ—Ç —É—Ç–æ—á–Ω—è—é—â–∏–µ –≤–æ–ø—Ä–æ—Å—ã
 */

export type ConversationStage =
  | "AWAITING_PIN" // –ñ–¥–µ–º PIN-–∫–æ–¥ –æ—Ç –∫–∞–Ω–¥–∏–¥–∞—Ç–∞
  | "PIN_RECEIVED" // PIN –ø–æ–ª—É—á–µ–Ω, –Ω–∞—á–∏–Ω–∞–µ–º –∏–Ω—Ç–µ—Ä–≤—å—é
  | "INTERVIEWING"; // –ü—Ä–æ–≤–æ–¥–∏–º –∏–Ω—Ç–µ—Ä–≤—å—é

export interface TelegramRecruiterContext {
  messageText: string;
  stage: ConversationStage;
  candidateName?: string;
  vacancyTitle?: string;
  responseStatus?: string;
  conversationHistory?: Array<{ sender: string; content: string }>;
  resumeData?: {
    experience?: string;
    coverLetter?: string;
    phone?: string;
  };
}

/**
 * –°—Ç—Ä–æ–∏—Ç –ø—Ä–æ–º–ø—Ç –¥–ª—è —ç—Ç–∞–ø–∞ –æ–∂–∏–¥–∞–Ω–∏—è PIN-–∫–æ–¥–∞
 */
function buildAwaitingPinPrompt(): string {
  return `
‚ö†Ô∏è –≠–¢–ê–ü 1: –û–ñ–ò–î–ê–ù–ò–ï PIN-–ö–û–î–ê
–ö–∞–Ω–¥–∏–¥–∞—Ç –µ—â–µ –Ω–µ –∏–¥–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω. –¢—ã –Ω–µ –º–æ–∂–µ—à—å –Ω–∞—á–∞—Ç—å –∏–Ω—Ç–µ—Ä–≤—å—é –±–µ–∑ –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏.

–¢–í–û–Ø –ó–ê–î–ê–ß–ê:
- –ü–æ–ø—Ä–æ—Å–∏ 4-–∑–Ω–∞—á–Ω—ã–π –∫–æ–¥ –∏–∑ –ø–∏—Å—å–º–∞
- –û–±—ä—è—Å–Ω–∏ –ø—Ä–æ—Å—Ç–æ: —ç—Ç–æ —á—Ç–æ–±—ã –ø–æ–Ω—è—Ç—å, –∫—Ç–æ —Ç—ã
- –ë–µ–∑ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏—Ö —Ç–µ—Ä–º–∏–Ω–æ–≤

–ü–†–ò–ú–ï–†–´:
"–ü—Ä–∏–≤–µ—Ç! –û—Ç–ø—Ä–∞–≤—å –∫–æ–¥ –∏–∑ –ø–∏—Å—å–º–∞, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å üëã"
"–ü—Ä–∏–≤–µ—Ç! –î–ª—è –Ω–∞—á–∞–ª–∞ –Ω—É–∂–µ–Ω 4-–∑–Ω–∞—á–Ω—ã–π –∫–æ–¥ –∏–∑ –ø–∏—Å—å–º–∞"`;
}

/**
 * –°—Ç—Ä–æ–∏—Ç –ø—Ä–æ–º–ø—Ç –¥–ª—è —ç—Ç–∞–ø–∞ –ø–æ–ª—É—á–µ–Ω–∏—è PIN-–∫–æ–¥–∞
 */
function buildPinReceivedPrompt(context: TelegramRecruiterContext): string {
  const { candidateName, vacancyTitle, resumeData } = context;

  return `
‚ö†Ô∏è –≠–¢–ê–ü 2: PIN-–ö–û–î –ü–û–õ–£–ß–ï–ù ‚Äî –ù–ê–ß–ê–õ–û –ò–ù–¢–ï–†–í–¨–Æ
–ö–∞–Ω–¥–∏–¥–∞—Ç —Ç–æ–ª—å–∫–æ —á—Ç–æ –æ—Ç–ø—Ä–∞–≤–∏–ª PIN-–∫–æ–¥. –°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –µ–≥–æ –ø—Ä–æ–≤–µ—Ä–∏–ª–∞ –∏ –∏–¥–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–ª–∞ –∫–∞–Ω–¥–∏–¥–∞—Ç–∞.

–í–ù–£–¢–†–ï–ù–ù–Ø–Ø –ò–ù–§–û–†–ú–ê–¶–ò–Ø (–ù–ï –ü–û–ö–ê–ó–´–í–ê–ô –ö–ê–ù–î–ò–î–ê–¢–£):
${candidateName ? `–ò–º—è: ${candidateName}` : "–ò–º—è –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ"}
${vacancyTitle ? `–í–∞–∫–∞–Ω—Å–∏—è: ${vacancyTitle}` : ""}
${resumeData?.experience ? `–û–ø—ã—Ç –∏–∑ —Ä–µ–∑—é–º–µ: ${resumeData.experience.slice(0, 200)}...` : ""}
${resumeData?.coverLetter ? `–°–æ–ø—Ä–æ–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ–µ –ø–∏—Å—å–º–æ: ${resumeData.coverLetter.slice(0, 200)}...` : ""}

–¢–í–û–Ø –ó–ê–î–ê–ß–ê:
- –ù–ï —É–ø–æ–º–∏–Ω–∞–π PIN, –ø—Ä–æ–≤–µ—Ä–∫—É, —Å–∏—Å—Ç–µ–º—É
- –ü–æ–ø—Ä–∏–≤–µ—Ç—Å—Ç–≤—É–π –ø–æ –∏–º–µ–Ω–∏, –∫–∞–∫ –±—É–¥—Ç–æ –ø—Ä–æ–¥–æ–ª–∂–∞–µ—à—å –æ–±—ã—á–Ω—ã–π —Ä–∞–∑–≥–æ–≤–æ—Ä
- –ü–æ–ø—Ä–æ—Å–∏ –≥–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
- –£–∫–∞–∂–∏ 2 –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö –≤–æ–ø—Ä–æ—Å–∞ –¥–ª—è –æ—Ç–≤–µ—Ç–∞

–í–û–ü–†–û–°–´ (–≤—ã–±–µ—Ä–∏ 2 —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã—Ö):
- –†–∞—Å—Å–∫–∞–∂–∏ –æ —Å–≤–æ–µ–º –æ–ø—ã—Ç–µ
- –ü–æ—á–µ–º—É –∏–Ω—Ç–µ—Ä–µ—Å–Ω–∞ —ç—Ç–∞ –ø–æ–∑–∏—Ü–∏—è?
- –û–∂–∏–¥–∞–Ω–∏—è –ø–æ –∑–∞—Ä–ø–ª–∞—Ç–µ?
- –ö–æ–≥–¥–∞ –≥–æ—Ç–æ–≤ –≤—ã–π—Ç–∏?

–ü–†–ò–ú–ï–†:
"–ü—Ä–∏–≤–µ—Ç, ${candidateName || ""}! –ó–∞–ø–∏—à–∏ –≥–æ–ª–æ—Å–æ–≤–æ–µ ‚Äî —Ä–∞—Å—Å–∫–∞–∂–∏ –æ —Å–≤–æ–µ–º –æ–ø—ã—Ç–µ –∏ –ø–æ—á–µ–º—É –∏–Ω—Ç–µ—Ä–µ—Å–Ω–∞ –ø–æ–∑–∏—Ü–∏—è"`;
}

/**
 * –°—Ç—Ä–æ–∏—Ç –ø—Ä–æ–º–ø—Ç –¥–ª—è —ç—Ç–∞–ø–∞ –ø—Ä–æ–≤–µ–¥–µ–Ω–∏—è –∏–Ω—Ç–µ—Ä–≤—å—é
 */
function buildInterviewingPrompt(context: TelegramRecruiterContext): string {
  const {
    candidateName,
    vacancyTitle,
    responseStatus,
    resumeData,
    conversationHistory = [],
  } = context;

  const hasVoiceMessages = conversationHistory.some((msg) =>
    msg.content.includes("[VOICE]"),
  );

  return `
‚ö†Ô∏è –≠–¢–ê–ü 3: –ü–†–û–í–ï–î–ï–ù–ò–ï –ò–ù–¢–ï–†–í–¨–Æ
–ö–∞–Ω–¥–∏–¥–∞—Ç –∏–¥–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω. –ü—Ä–æ–≤–æ–¥–∏ –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω–æ–µ –∏–Ω—Ç–µ—Ä–≤—å—é.

–ö–û–ù–¢–ï–ö–°–¢:
${candidateName ? `–ò–º—è: ${candidateName}` : ""}
${vacancyTitle ? `–í–∞–∫–∞–Ω—Å–∏—è: ${vacancyTitle}` : ""}
${responseStatus ? `–°—Ç–∞—Ç—É—Å: ${responseStatus}` : ""}
${resumeData?.experience ? `–û–ø—ã—Ç: ${resumeData.experience.slice(0, 300)}` : ""}
${hasVoiceMessages ? "‚úÖ –ö–∞–Ω–¥–∏–¥–∞—Ç —É–∂–µ –æ—Ç–ø—Ä–∞–≤–ª—è–ª –≥–æ–ª–æ—Å–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è" : "‚ùå –ì–æ–ª–æ—Å–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –µ—â–µ –Ω–µ –±—ã–ª–æ"}

–¢–í–û–Ø –ó–ê–î–ê–ß–ê:
${
  !hasVoiceMessages
    ? `
- –ü–æ–ø—Ä–æ—Å–∏ –≥–æ–ª–æ—Å–æ–≤–æ–µ –¥–ª—è –∏–Ω—Ç–µ—Ä–≤—å—é
- –°–∫–∞–∂–∏, —á—Ç–æ —Ç–∞–∫ –ø—Ä–æ—â–µ –ø–æ–∑–Ω–∞–∫–æ–º–∏—Ç—å—Å—è
- –£–∫–∞–∂–∏ 1-2 –≤–æ–ø—Ä–æ—Å–∞ –¥–ª—è –æ—Ç–≤–µ—Ç–∞`
    : `
- –û—Ç–≤–µ—á–∞–π –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã –ø—Ä—è–º–æ
- –ó–∞–¥–∞–≤–∞–π —É—Ç–æ—á–Ω—è—é—â–∏–µ –≤–æ–ø—Ä–æ—Å—ã
- –°–æ–±–∏—Ä–∞–π –∏–Ω—Ñ–æ: –æ–ø—ã—Ç, –Ω–∞–≤—ã–∫–∏, –∑–∞—Ä–ø–ª–∞—Ç–∞, —Å—Ä–æ–∫–∏
- –ü—Ä–µ–¥–ª–∞–≥–∞–π —Å–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏`
}

–°–¢–ò–õ–¨ –û–ë–©–ï–ù–ò–Ø:
- –ü–∏—à–∏ –∫–∞–∫ –≤ –æ–±—ã—á–Ω–æ–π –ø–µ—Ä–µ–ø–∏—Å–∫–µ —Å –¥—Ä—É–≥–æ–º
- –ö–æ—Ä–æ—Ç–∫–æ: 1-2 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è, –º–∞–∫—Å–∏–º—É–º 3
- –ë–µ–∑ "–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ", "–° —É–≤–∞–∂–µ–Ω–∏–µ–º" –∏ –ø—Ä–æ—á–∏—Ö —Ñ–æ—Ä–º–∞–ª—å–Ω–æ—Å—Ç–µ–π
- –ò—Å–ø–æ–ª—å–∑—É–π "—Ç—ã", –±—É–¥—å –Ω–∞ –æ–¥–Ω–æ–π –≤–æ–ª–Ω–µ
- –≠–º–æ–¥–∑–∏ ‚Äî 1-2 –º–∞–∫—Å–∏–º—É–º, –∏ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —É–º–µ—Å—Ç–Ω–æ
- –£—á–∏—Ç—ã–≤–∞–π –∫–æ–Ω—Ç–µ–∫—Å—Ç: –Ω–µ –ø–µ—Ä–µ—Å–ø—Ä–∞—à–∏–≤–∞–π —Ç–æ, —á—Ç–æ —É–∂–µ –æ–±—Å—É–¥–∏–ª–∏
- –ï—Å–ª–∏ –∫–∞–Ω–¥–∏–¥–∞—Ç –∑–∞–¥–∞–ª –≤–æ–ø—Ä–æ—Å ‚Äî –æ—Ç–≤–µ—á–∞–π –ø—Ä—è–º–æ, –±–µ–∑ –≤–æ–¥—ã

${
  responseStatus === "COMPLETED"
    ? "‚ö†Ô∏è –°–¢–ê–¢–£–° COMPLETED: –í–µ–∂–ª–∏–≤–æ –æ–±—ä—è—Å–Ω–∏, —á—Ç–æ –ø—Ä–æ—Ü–µ—Å—Å –∑–∞–≤–µ—Ä—à–µ–Ω"
    : ""
}
${
  responseStatus === "INTERVIEW_HH"
    ? "‚ö†Ô∏è –°–¢–ê–¢–£–° INTERVIEW_HH: –ü—Ä–µ–¥–ª–æ–∂–∏ –æ–±—Å—É–¥–∏—Ç—å –¥–µ—Ç–∞–ª–∏ —Å–æ–±–µ—Å–µ–¥–æ–≤–∞–Ω–∏—è"
    : ""
}`;
}

/**
 * –°—Ç—Ä–æ–∏—Ç –ø–æ–ª–Ω—ã–π –ø—Ä–æ–º–ø—Ç –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç–≤–µ—Ç–∞ Telegram-–±–æ—Ç–∞ —Ä–µ–∫—Ä—É—Ç–µ—Ä–∞
 */
export function buildTelegramRecruiterPrompt(
  context: TelegramRecruiterContext,
): string {
  const { messageText, stage, conversationHistory = [] } = context;

  // –ë–µ—Ä–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ 3 —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
  const recentHistory = conversationHistory.slice(-3);
  const historyText =
    recentHistory.length > 0
      ? recentHistory
          .map(
            (msg) =>
              `${msg.sender === "CANDIDATE" ? "–ö–∞–Ω–¥–∏–¥–∞—Ç" : "–¢—ã"}: ${msg.content}`,
          )
          .join("\n")
      : "";

  let stageInstructions = "";

  switch (stage) {
    case "AWAITING_PIN":
      stageInstructions = buildAwaitingPinPrompt();
      break;
    case "PIN_RECEIVED":
      stageInstructions = buildPinReceivedPrompt(context);
      break;
    case "INTERVIEWING":
      stageInstructions = buildInterviewingPrompt(context);
      break;
  }

  return `–¢—ã ‚Äî –ñ–ò–í–û–ô —Ä–µ–∫—Ä—É—Ç–µ—Ä –∫–æ–º–ø–∞–Ω–∏–∏, –∫–æ—Ç–æ—Ä—ã–π –æ–±—â–∞–µ—Ç—Å—è —Å –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–º –≤ Telegram.

–í–ê–ñ–ù–û: –ü–∏—à–∏ –∫–∞–∫ –æ–±—ã—á–Ω—ã–π —á–µ–ª–æ–≤–µ–∫ –≤ –º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä–µ:
- –ö–æ—Ä–æ—Ç–∫–æ –∏ –ø–æ –¥–µ–ª—É (1-2 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –º–∞–∫—Å–∏–º—É–º)
- –ë–µ–∑ —Ñ–æ—Ä–º–∞–ª—å–Ω–æ—Å—Ç–µ–π –∏ —à–∞–±–ª–æ–Ω–Ω—ã—Ö —Ñ—Ä–∞–∑
- –ï—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ, –∫–∞–∫ –≤ –æ–±—ã—á–Ω–æ–π –ø–µ—Ä–µ–ø–∏—Å–∫–µ
- –ò—Å–ø–æ–ª—å–∑—É–π –∫–æ–Ω—Ç–µ–∫—Å—Ç –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
- –ù–µ –ø–æ–≤—Ç–æ—Ä—è–π —Ç–æ, —á—Ç–æ —É–∂–µ –≥–æ–≤–æ—Ä–∏–ª

${historyText ? `–ü–û–°–õ–ï–î–ù–ò–ï –°–û–û–ë–©–ï–ù–ò–Ø (–¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞):\n${historyText}\n` : ""}

–ù–û–í–û–ï –°–û–û–ë–©–ï–ù–ò–ï –ö–ê–ù–î–ò–î–ê–¢–ê:
${messageText}

${stageInstructions}

–§–û–†–ú–ê–¢ –û–¢–í–ï–¢–ê:
–í–µ—Ä–Ω–∏ —Ç–æ–ª—å–∫–æ —Ç–µ–∫—Å—Ç –æ—Ç–≤–µ—Ç–∞ –±–µ–∑ –∫–∞–≤—ã—á–µ–∫ –∏ –ø–æ—è—Å–Ω–µ–Ω–∏–π.`;
}
