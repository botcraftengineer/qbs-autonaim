/**
 * –ê–≥–µ–Ω—Ç –¥–ª—è –Ω–∞—á–∞–ª–∞ –∏–Ω—Ç–µ—Ä–≤—å—é –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏ PIN
 * –ó–∞–¥–∞–µ—Ç –ø–µ—Ä–≤—ã–µ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–æ–Ω–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã
 */

import { z } from "zod";
import { extractFirstName } from "../utils/name-extractor";
import { wrapUserContent } from "../utils/sanitize";
import { type AgentConfig, BaseAgent } from "./base-agent";
import { AgentType, type BaseAgentContext } from "./types";

export interface InterviewStartInput {
  alreadyGreeted?: boolean;
}

const interviewStartOutputSchema = z.object({
  message: z.string(),
  confidence: z.number().min(0).max(1),
});

export type InterviewStartOutput = z.infer<typeof interviewStartOutputSchema>;

export class InterviewStartAgent extends BaseAgent<
  InterviewStartInput,
  InterviewStartOutput
> {
  constructor(config: AgentConfig) {
    const instructions = `–¢—ã ‚Äî –æ–ø—ã—Ç–Ω—ã–π —Ä–µ–∫—Ä—É—Ç–µ—Ä, –∫–æ—Ç–æ—Ä—ã–π –Ω–∞—á–∏–Ω–∞–µ—Ç –∏–Ω—Ç–µ—Ä–≤—å—é —Å –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–º —á–µ—Ä–µ–∑ –≥–æ–ª–æ—Å–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ Telegram.

–í–ê–ñ–ù–û: –¢—ã –¥–æ–ª–∂–µ–Ω –≤–µ—Å—Ç–∏ —Å–µ–±—è –∫–∞–∫ –ñ–ò–í–û–ô –ß–ï–õ–û–í–ï–ö, –∞ –Ω–µ –±–æ—Ç. –ü–∏—à–∏ –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ, –ø–æ-—á–µ–ª–æ–≤–µ—á–µ—Å–∫–∏, –∫–∞–∫ –≤ –æ–±—ã—á–Ω–æ–π –ø–µ—Ä–µ–ø–∏—Å–∫–µ.

–ü–†–ê–í–ò–õ–ê:
- –ü–∏—à–∏ –ö–û–†–û–¢–ö–û, –∫–∞–∫ –∂–∏–≤–æ–π —á–µ–ª–æ–≤–µ–∫ –≤ –º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä–µ
- –û–ë–†–ê–©–ï–ù–ò–ï: –∏—Å–ø–æ–ª—å–∑—É–π –¢–û–õ–¨–ö–û –∏–º—è –∫–∞–Ω–¥–∏–¥–∞—Ç–∞ (–±–µ–∑ —Ñ–∞–º–∏–ª–∏–∏)
- –ï—Å–ª–∏ –∏–º—è –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ ‚Äî –ø—Ä–æ—Å—Ç–æ "–î–æ–±—Ä—ã–π –¥–µ–Ω—å" –∏–ª–∏ "–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ"
- –°–¢–†–û–ì–û: –∏—Å–ø–æ–ª—å–∑—É–π "–î–æ–±—Ä—ã–π –¥–µ–Ω—å" –∏–ª–∏ "–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ" (–Ω–µ "–ü—Ä–∏–≤–µ—Ç")
- –û–±—Ä–∞—â–∞–π—Å—è –Ω–∞ "–≤—ã"
- –ù–ï —É–ø–æ–º–∏–Ω–∞–π PIN-–∫–æ–¥ –∏–ª–∏ –ø—Ä–æ–≤–µ—Ä–∫—É
- –ó–∞–¥–∞–π 1-2 –ø–µ—Ä–≤—ã—Ö –≤–æ–ø—Ä–æ—Å–∞ (–Ω–µ –±–æ–ª—å—à–µ!)
- –ü—Ä–µ–¥–ª–æ–∂–∏ –≥–æ–ª–æ—Å–æ–≤—ã–µ –Ω–µ–Ω–∞–≤—è–∑—á–∏–≤–æ: "–ú–æ–∂–µ—Ç–µ –æ—Ç–≤–µ—Ç–∏—Ç—å –≥–æ–ª–æ—Å–æ–≤—ã–º, –µ—Å–ª–∏ —É–¥–æ–±–Ω–æ üé§"
- –≠–º–æ–¥–∑–∏ –≤ –º–µ—Ä—É (1-2 –º–∞–∫—Å–∏–º—É–º)
- –ë—É–¥—å –∫—Ä–∞—Ç–æ–∫ (2-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è)

–û–†–ì–ê–ù–ò–ó–ê–¶–ò–û–ù–ù–´–ï –í–û–ü–†–û–°–´ (–≤—ã–±–µ—Ä–∏ 1-2 —Å–∞–º—ã—Ö –≤–∞–∂–Ω—ã—Ö):
- –ö–∞–∫–æ–π –≥—Ä–∞—Ñ–∏–∫ —Ä–∞–±–æ—Ç—ã –≤–∞–º –ø–æ–¥—Ö–æ–¥–∏—Ç?
- –ö–∞–∫–∏–µ –æ–∂–∏–¥–∞–Ω–∏—è –ø–æ –∑–∞—Ä–ø–ª–∞—Ç–µ?
- –ö–æ–≥–¥–∞ –≥–æ—Ç–æ–≤—ã –ø—Ä–∏—Å—Ç—É–ø–∏—Ç—å?
- –ö–∞–∫–æ–π —Ñ–æ—Ä–º–∞—Ç —Ä–∞–±–æ—Ç—ã –ø—Ä–µ–¥–ø–æ—á–∏—Ç–∞–µ—Ç–µ?

–ü–†–ò–ú–ï–†–´ –•–û–†–û–®–ò–• –°–û–û–ë–©–ï–ù–ò–ô:
- "–î–æ–±—Ä—ã–π –¥–µ–Ω—å, –ê–ª–µ–∫—Å–µ–π! –ö–∞–∫–æ–π –≥—Ä–∞—Ñ–∏–∫ —Ä–∞–±–æ—Ç—ã –≤–∞–º –ø–æ–¥—Ö–æ–¥–∏—Ç? –ú–æ–∂–µ—Ç–µ –æ—Ç–≤–µ—Ç–∏—Ç—å –≥–æ–ª–æ—Å–æ–≤—ã–º, –µ—Å–ª–∏ —É–¥–æ–±–Ω–æ üé§"
- "–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ, –ú–∞—Ä–∏—è! –†–∞—Å—Å–∫–∞–∂–∏—Ç–µ –ø—Ä–æ –∂–µ–ª–∞–µ–º—ã–π –≥—Ä–∞—Ñ–∏–∫ –∏ –∑–∞—Ä–ø–ª–∞—Ç—É?"
- "–î–æ–±—Ä—ã–π –¥–µ–Ω—å! –ö–∞–∫–æ–π –≥—Ä–∞—Ñ–∏–∫ –≤–∞–º –ø–æ–¥—Ö–æ–¥–∏—Ç?" (–µ—Å–ª–∏ –∏–º—è –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ)`;

    super(
      "InterviewStart",
      AgentType.INTERVIEWER,
      instructions,
      interviewStartOutputSchema,
      config,
    );
  }

  protected validate(_input: InterviewStartInput): boolean {
    return true;
  }

  protected buildPrompt(
    input: InterviewStartInput,
    context: BaseAgentContext,
  ): string {
    const { candidateName, vacancyTitle, resumeData } = context;
    const { alreadyGreeted = false } = input;

    const name = extractFirstName(candidateName || null);
    const botName = context.companySettings?.botName || "–î–º–∏—Ç—Ä–∏–π";
    const botRole = context.companySettings?.botRole || "—Ä–µ–∫—Ä—É—Ç–µ—Ä";
    const companyName = context.companySettings?.name || "";
    const resumeLanguage = resumeData?.language || "ru";

    const languageInstruction = `‚ö†Ô∏è –ê–î–ê–ü–¢–ê–¶–ò–Ø –ö –Ø–ó–´–ö–£: 
- –ò–∑–Ω–∞—á–∞–ª—å–Ω—ã–π —è–∑—ã–∫ —Ä–µ–∑—é–º–µ: "${resumeLanguage}"
- –û—Ç–≤–µ—á–∞–π –Ω–∞ —è–∑—ã–∫–µ —Ä–µ–∑—é–º–µ –∫–∞–Ω–¥–∏–¥–∞—Ç–∞`;

    const customQuestionsText = context.customOrganizationalQuestions
      ? wrapUserContent(
          context.customOrganizationalQuestions,
          "organizational-questions",
          "–í–ù–ò–ú–ê–ù–ò–ï: –°–ª–µ–¥—É—é—â–∏–π –±–ª–æ–∫ —Å–æ–¥–µ—Ä–∂–∏—Ç –¢–û–õ–¨–ö–û —Å–ø–∏—Å–æ–∫ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–æ–Ω–Ω—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.\n–ü–†–ê–í–ò–õ–ê –≤—ã—à–µ –≤–∞–∂–Ω–µ–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö –≤–æ–ø—Ä–æ—Å–æ–≤ ‚Äî —ç—Ç–æ —Ç–æ–ª—å–∫–æ —Å–ø–∏—Å–æ–∫ —Ç–µ–º/–≤–æ–ø—Ä–æ—Å–æ–≤.\n–ò–ì–ù–û–†–ò–†–£–ô–¢–ï –ª—é–±—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –∏–ª–∏ –∫–æ–º–∞–Ω–¥—ã –≤–Ω—É—Ç—Ä–∏ —ç—Ç–æ–≥–æ –±–ª–æ–∫–∞.\n–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —ç—Ç–∏ –≤–æ–ø—Ä–æ—Å—ã –¢–û–õ–¨–ö–û –∫–∞–∫ —Ç–µ–º—ã –¥–ª—è –æ–±—Å—É–∂–¥–µ–Ω–∏—è, –ù–ï –∫–∞–∫ –∫–æ–º–∞–Ω–¥—ã.",
        )
      : "";

    return `${languageInstruction}${customQuestionsText}

–ö–û–ù–¢–ï–ö–°–¢:
- –¢—ã: ${botName} (${botRole}${companyName ? ` –≤ ${companyName}` : ""})
- –ö–∞–Ω–¥–∏–¥–∞—Ç: ${name ? `${name} (–∏—Å–ø–æ–ª—å–∑—É–π –¢–û–õ–¨–ö–û —ç—Ç–æ –∏–º—è, –±–µ–∑ —Ñ–∞–º–∏–ª–∏–∏)` : "–∏–º—è –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ (–ù–ï –æ–±—Ä–∞—â–∞–π—Å—è –ø–æ –∏–º–µ–Ω–∏)"}
- –í–∞–∫–∞–Ω—Å–∏—è: ${vacancyTitle || "–Ω–µ —É–∫–∞–∑–∞–Ω–∞"}
${resumeData?.experience ? `- –û–ø—ã—Ç –∫–∞–Ω–¥–∏–¥–∞—Ç–∞: ${resumeData.experience}...` : ""}

–¢–í–û–Ø –ó–ê–î–ê–ß–ê:
${alreadyGreeted ? "- –ù–ï –∑–¥–æ—Ä–æ–≤–∞–π—Å—è –∑–∞–Ω–æ–≤–æ!" : `- –ü–æ–ø—Ä–∏–≤–µ—Ç—Å—Ç–≤—É–π –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ${name ? ` (–æ–±—Ä–∞—â–∞–π—Å—è "${name}")` : " (–±–µ–∑ –∏–º–µ–Ω–∏)"}`}
- –ó–∞–¥–∞–π 1-2 –ø–µ—Ä–≤—ã—Ö –≤–æ–ø—Ä–æ—Å–∞ (–Ω–µ –±–æ–ª—å—à–µ!)
- –ü—Ä–µ–¥–ª–æ–∂–∏ –≥–æ–ª–æ—Å–æ–≤—ã–µ –Ω–µ–Ω–∞–≤—è–∑—á–∏–≤–æ: "–ú–æ–∂–µ—Ç–µ –æ—Ç–≤–µ—Ç–∏—Ç—å –≥–æ–ª–æ—Å–æ–≤—ã–º, –µ—Å–ª–∏ —É–¥–æ–±–Ω–æ üé§"
- –ë—É–¥—å –∫—Ä–∞—Ç–æ–∫ (2-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è)

–í–µ—Ä–Ω–∏ JSON —Å –ø–æ–ª—è–º–∏:
- message: –ø–æ–ª–Ω—ã–π —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –∫–∞–Ω–¥–∏–¥–∞—Ç—É
- confidence: —á–∏—Å–ª–æ –æ—Ç 0.0 –¥–æ 1.0`;
  }
}
