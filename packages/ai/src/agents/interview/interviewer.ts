/**
 * –ê–≥–µ–Ω—Ç –¥–ª—è –ø—Ä–æ–≤–µ–¥–µ–Ω–∏—è –∏–Ω—Ç–µ—Ä–≤—å—é
 */

import { z } from "zod";
import { extractFirstName } from "../../utils/name-extractor";
import { wrapUserContent } from "../../utils/sanitize";
import { type AgentConfig, BaseAgent } from "../core/base-agent";
import { RECRUITER_PERSONA } from "../core/persona";
import { getConversationContext, getVoiceMessagesInfo } from "../core/tools";
import { AgentType, type BaseAgentContext } from "../core/types";

export interface InterviewerInput {
  questionNumber: number;
  customOrganizationalQuestions?: string | null;
  customInterviewQuestions?: string | null; // –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –≤–æ–ø—Ä–æ—Å—ã
  resumeLanguage?: string;
}

const interviewerOutputSchema = z.object({
  analysis: z.string(),
  shouldContinue: z.boolean(),
  reason: z.string(),
  nextQuestion: z.string(),
  confidence: z.number().min(0).max(1),
  waitingForCandidateResponse: z.boolean(),
  isSimpleAcknowledgment: z.boolean(),
});

export type InterviewerOutput = z.infer<typeof interviewerOutputSchema>;

export class InterviewerAgent extends BaseAgent<
  InterviewerInput,
  InterviewerOutput
> {
  constructor(config: AgentConfig) {
    const instructions = `${RECRUITER_PERSONA.INSTRUCTIONS}

–¢–í–û–Ø –ó–ê–î–ê–ß–ê:
- –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –æ—Ç–≤–µ—Ç –∫–∞–Ω–¥–∏–¥–∞—Ç–∞ –Ω–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–π –≤–æ–ø—Ä–æ—Å.
- –°—Ñ–æ—Ä–º—É–ª–∏—Ä—É–π —Å–ª–µ–¥—É—é—â–∏–π —É—Ç–æ—á–Ω—è—é—â–∏–π –∏–ª–∏ –Ω–æ–≤—ã–π –≤–æ–ø—Ä–æ—Å.
- –ï—Å–ª–∏ –µ—Å—Ç—å –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ–º—ã ‚Äî –∑–∞–¥–∞–≤–∞–π –≤–æ–ø—Ä–æ—Å—ã –æ –≥—Ä–∞—Ñ–∏–∫–µ, –∑–∞—Ä–ø–ª–∞—Ç–µ, –ª–æ–∫–∞—Ü–∏–∏.
- –ï—Å–ª–∏ –µ—Å—Ç—å —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Ç–µ–º—ã ‚Äî —É–≥–ª—É–±–ª—è–π—Å—è –≤ –æ–ø—ã—Ç –∏ –Ω–∞–≤—ã–∫–∏.
- –î–ª—è gig-–∏–Ω—Ç–µ—Ä–≤—å—é (—Ä–∞–∑–æ–≤—ã—Ö –∑–∞–¥–∞—á) –ù–ï –∑–∞–¥–∞–≤–∞–π –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–æ–Ω–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã, —Ñ–æ–∫—É—Å–∏—Ä—É–π—Å—è –Ω–∞ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã—Ö –Ω–∞–≤—ã–∫–∞—Ö.
- –ò—Å–ø–æ–ª—å–∑—É–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –∏—Å—Ç–æ—Ä–∏–∏, –µ—Å–ª–∏ —ç—Ç–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ.

${RECRUITER_PERSONA.GREETING_RULES}`;

    super(
      "Interviewer",
      AgentType.INTERVIEWER,
      instructions,
      interviewerOutputSchema,
      {
        ...config,
        tools: {
          getVoiceMessagesInfo,
          getConversationContext,
        },
      },
    );
  }

  protected validate(input: InterviewerInput): boolean {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è
    if (!Number.isFinite(input.questionNumber) || input.questionNumber < 0) {
      console.error(
        "[InterviewerAgent] Invalid questionNumber:",
        JSON.stringify({
          questionNumber: input.questionNumber,
          type: typeof input.questionNumber,
        }),
      );
      return false;
    }

    // –õ–æ–≥–∏—Ä—É–µ–º —É—Å–ø–µ—à–Ω—É—é –≤–∞–ª–∏–¥–∞—Ü–∏—é –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
    console.log("[InterviewerAgent] Validation passed:", {
      questionNumber: input.questionNumber,
    });

    return true;
  }

  protected buildPrompt(
    input: InterviewerInput,
    context: BaseAgentContext,
  ): string {
    const { candidateName, vacancyTitle, vacancyDescription } = context;
    const { resumeLanguage = "ru" } = input;

    const name = extractFirstName(candidateName || null);
    const botName = context.botSettings?.botName || "–î–º–∏—Ç—Ä–∏–π";
    const botRole = context.botSettings?.botRole || "—Ä–µ–∫—Ä—É—Ç–µ—Ä";
    const companyName = context.botSettings?.companyName || "";

    // –ü–µ—Ä–µ–¥–∞—ë–º –ø–æ–ª–Ω—É—é –∏—Å—Ç–æ—Ä–∏—é –¥–∏–∞–ª–æ–≥–∞ –±–µ–∑ –æ–±—Ä–µ–∑–∫–∏
    const historyText =
      context.conversationHistory.length > 0
        ? context.conversationHistory
            .map((msg) => {
              const sender = msg.sender === "CANDIDATE" ? "–ö" : "–Ø";
              return `${sender}: ${msg.content}`;
            })
            .join("\n")
        : "";

    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø –∏–Ω—Ç–µ—Ä–≤—å—é –ø–æ –Ω–∞–ª–∏—á–∏—é –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–æ–Ω–Ω—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤
    // –ï—Å–ª–∏ customOrganizationalQuestions === null, —ç—Ç–æ –º–æ–∂–µ—Ç –±—ã—Ç—å gig –±–µ–∑ –æ—Ä–≥. –≤–æ–ø—Ä–æ—Å–æ–≤
    const isGigInterview = input.customOrganizationalQuestions === null;

    // –ü–µ—Ä–µ–¥–∞—ë–º –∫–∞—Å—Ç–æ–º–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã –±–µ–∑ –æ–±—Ä–µ–∑–∫–∏
    const organizationalQuestionsBlock = input.customOrganizationalQuestions
      ? wrapUserContent(
          input.customOrganizationalQuestions,
          "organizational-questions",
          "–û–†–ì–ê–ù–ò–ó–ê–¶–ò–û–ù–ù–´–ï –¢–ï–ú–´:",
        )
      : "";

    const technicalQuestionsBlock = input.customInterviewQuestions
      ? wrapUserContent(
          input.customInterviewQuestions,
          "technical-questions",
          "–¢–ï–•–ù–ò–ß–ï–°–ö–ò–ï –¢–ï–ú–´:",
        )
      : "";

    // –ü–µ—Ä–µ–¥–∞—ë–º –æ–ø–∏—Å–∞–Ω–∏–µ –≤–∞–∫–∞–Ω—Å–∏–∏ –±–µ–∑ –æ–±—Ä–µ–∑–∫–∏
    const shortVacancyDesc = vacancyDescription || "";

    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ª–æ–≥–∏–∫—É –≤–æ–ø—Ä–æ—Å–æ–≤ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞ –∏–Ω—Ç–µ—Ä–≤—å—é
    const interviewLogic = isGigInterview
      ? `–õ–æ–≥–∏–∫–∞ –∏–Ω—Ç–µ—Ä–≤—å—é (GIG - —Ä–∞–∑–æ–≤–∞—è –∑–∞–¥–∞—á–∞):
1. –ê–Ω–∞–ª–∏–∑–∏—Ä—É–π –∏—Å—Ç–æ—Ä–∏—é –¥–∏–∞–ª–æ–≥–∞, —á—Ç–æ–±—ã –ø–æ–Ω—è—Ç—å –∫–æ–Ω—Ç–µ–∫—Å—Ç
2. –ù–µ –ø–æ–≤—Ç–æ—Ä—è–π –≤–æ–ø—Ä–æ—Å—ã –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏
3. –ó–∞–¥–∞–≤–∞–π –¢–û–õ–¨–ö–û –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–µ/—Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –≤–æ–ø—Ä–æ—Å—ã
4. –ù–ï —Å–ø—Ä–∞—à–∏–≤–∞–π –ø—Ä–æ –≥—Ä–∞—Ñ–∏–∫ —Ä–∞–±–æ—Ç—ã, –∑–∞—Ä–ø–ª–∞—Ç—É, —Ñ–æ—Ä–º–∞—Ç —Ä–∞–±–æ—Ç—ã - —ç—Ç–æ —Ä–∞–∑–æ–≤–∞—è –∑–∞–¥–∞—á–∞
5. –§–æ–∫—É—Å–∏—Ä—É–π—Å—è –Ω–∞ –æ–ø—ã—Ç–µ, –Ω–∞–≤—ã–∫–∞—Ö, –ø–æ—Ä—Ç—Ñ–æ–ª–∏–æ
6. –ï—Å–ª–∏ –æ—Ç–≤–µ—Ç –ø–æ–ª–Ω—ã–π - –ø–µ—Ä–µ—Ö–æ–¥–∏ –∫ —Å–ª–µ–¥—É—é—â–µ–π —Ç–µ–º–µ
7. –ï—Å–ª–∏ —Å–æ–±—Ä–∞–ª –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ - –∑–∞–≤–µ—Ä—à–∞–π (shouldContinue: false)`
      : `–õ–æ–≥–∏–∫–∞ –∏–Ω—Ç–µ—Ä–≤—å—é (–≤–∞–∫–∞–Ω—Å–∏—è):
1. –ê–Ω–∞–ª–∏–∑–∏—Ä—É–π –∏—Å—Ç–æ—Ä–∏—é –¥–∏–∞–ª–æ–≥–∞, —á—Ç–æ–±—ã –ø–æ–Ω—è—Ç—å –∫–æ–Ω—Ç–µ–∫—Å—Ç
2. –ù–µ –ø–æ–≤—Ç–æ—Ä—è–π –≤–æ–ø—Ä–æ—Å—ã –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏
3. –°–Ω–∞—á–∞–ª–∞ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ–º—ã, –ø–æ—Ç–æ–º —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ
4. –ï—Å–ª–∏ –æ—Ç–≤–µ—Ç –ø–æ–ª–Ω—ã–π - –ø–µ—Ä–µ—Ö–æ–¥–∏ –∫ —Å–ª–µ–¥—É—é—â–µ–π —Ç–µ–º–µ
5. –ï—Å–ª–∏ —Å–æ–±—Ä–∞–ª –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ - –∑–∞–≤–µ—Ä—à–∞–π (shouldContinue: false)`;

    const firstInteractionLogic = isGigInterview
      ? `a) –ü–ï–†–í–û–ï –í–ó–ê–ò–ú–û–î–ï–ô–°–¢–í–ò–ï (question_number=1):
   - –ö–∞–Ω–¥–∏–¥–∞—Ç –æ—Ç–≤–µ—Ç–∏–ª –Ω–∞ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ
   ‚Üí –ó–∞–¥–∞–π 1-2 –ø–µ—Ä–≤—ã—Ö –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã—Ö –≤–æ–ø—Ä–æ—Å–∞ –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ (–ø—Ä–æ –æ–ø—ã—Ç, –Ω–∞–≤—ã–∫–∏, –ø–æ—Ä—Ç—Ñ–æ–ª–∏–æ)
   ‚Üí –ù–ï —Å–ø—Ä–∞—à–∏–≤–∞–π –ø—Ä–æ –≥—Ä–∞—Ñ–∏–∫, –∑–∞—Ä–ø–ª–∞—Ç—É - —ç—Ç–æ —Ä–∞–∑–æ–≤–∞—è –∑–∞–¥–∞—á–∞
   ‚Üí –£–ø–æ–º—è–Ω–∏ –ø—Ä–æ –≥–æ–ª–æ—Å–æ–≤—ã–µ –Ω–µ–Ω–∞–≤—è–∑—á–∏–≤–æ: "–ú–æ–∂–µ—Ç–µ –æ—Ç–≤–µ—Ç–∏—Ç—å –≥–æ–ª–æ—Å–æ–≤—ã–º, –µ—Å–ª–∏ —É–¥–æ–±–Ω–æ üé§"
   ‚Üí analysis: "–ö–∞–Ω–¥–∏–¥–∞—Ç –≥–æ—Ç–æ–≤ –∫ –∏–Ω—Ç–µ—Ä–≤—å—é"
   ‚Üí shouldContinue: true
   ‚Üí nextQuestion: –∫–æ—Ä–æ—Ç–∫–∏–π –≤–æ–ø—Ä–æ—Å (–Ω–∞–ø—Ä–∏–º–µ—Ä: "–†–∞—Å—Å–∫–∞–∂–∏—Ç–µ –æ –≤–∞—à–µ–º –æ–ø—ã—Ç–µ –≤ —ç—Ç–æ–π –æ–±–ª–∞—Å—Ç–∏?")`
      : `a) –ü–ï–†–í–û–ï –í–ó–ê–ò–ú–û–î–ï–ô–°–¢–í–ò–ï (question_number=1):
   - –ö–∞–Ω–¥–∏–¥–∞—Ç –æ—Ç–≤–µ—Ç–∏–ª –Ω–∞ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ
   ‚Üí –ó–∞–¥–∞–π 1-2 –ø–µ—Ä–≤—ã—Ö –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–æ–Ω–Ω—ã—Ö –≤–æ–ø—Ä–æ—Å–∞ –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ
   ‚Üí –£–ø–æ–º—è–Ω–∏ –ø—Ä–æ –≥–æ–ª–æ—Å–æ–≤—ã–µ –Ω–µ–Ω–∞–≤—è–∑—á–∏–≤–æ: "–ú–æ–∂–µ—Ç–µ –æ—Ç–≤–µ—Ç–∏—Ç—å –≥–æ–ª–æ—Å–æ–≤—ã–º, –µ—Å–ª–∏ —É–¥–æ–±–Ω–æ üé§"
   ‚Üí analysis: "–ö–∞–Ω–¥–∏–¥–∞—Ç –≥–æ—Ç–æ–≤ –∫ –∏–Ω—Ç–µ—Ä–≤—å—é"
   ‚Üí shouldContinue: true
   ‚Üí nextQuestion: –∫–æ—Ä–æ—Ç–∫–∏–π –≤–æ–ø—Ä–æ—Å (–Ω–∞–ø—Ä–∏–º–µ—Ä: "–ö–∞–∫–æ–π –≥—Ä–∞—Ñ–∏–∫ —Ä–∞–±–æ—Ç—ã –≤–∞–º –ø–æ–¥—Ö–æ–¥–∏—Ç?")`;

    return `–ö–û–ù–¢–ï–ö–°–¢:
–Ø–∑—ã–∫ —Ä–µ–∑—é–º–µ: <resume_language>${resumeLanguage}</resume_language>
–ê–¥–∞–ø—Ç–∏—Ä—É–π—Å—è –∫ —è–∑—ã–∫—É –æ—Ç–≤–µ—Ç–æ–≤ –∫–∞–Ω–¥–∏–¥–∞—Ç–∞.

–ë–æ—Ç: <bot_name>${botName}</bot_name>, <bot_role>${botRole}</bot_role>${companyName ? `, <company>${companyName}</company>` : ""}
–ö–∞–Ω–¥–∏–¥–∞—Ç: <candidate_name>${name}</candidate_name>
–í–∞–∫–∞–Ω—Å–∏—è: <vacancy_title>${vacancyTitle || "–Ω–µ —É–∫–∞–∑–∞–Ω–∞"}</vacancy_title>${shortVacancyDesc ? `\n<vacancy_description>${shortVacancyDesc}</vacancy_description>` : ""}

${organizationalQuestionsBlock}
${technicalQuestionsBlock}

${historyText ? `–ò–°–¢–û–†–ò–Ø –î–ò–ê–õ–û–ì–ê:\n${historyText}\n` : ""}

–¢–ï–ö–£–©–ï–ï –í–ó–ê–ò–ú–û–î–ï–ô–°–¢–í–ò–ï:
–ù–æ–º–µ—Ä –≤–æ–ø—Ä–æ—Å–∞: <question_number>${input.questionNumber}</question_number>
–ü–µ—Ä–≤–æ–µ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ: <is_first_interaction>${input.questionNumber === 1}</is_first_interaction>
–ê–Ω–∞–ª–∏–∑–∏—Ä—É–π –ø–æ—Å–ª–µ–¥–Ω–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –∫–∞–Ω–¥–∏–¥–∞—Ç–∞ –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏ –¥–∏–∞–ª–æ–≥–∞.

–ü–†–ê–í–ò–õ–ê:

${interviewLogic}

‚ö†Ô∏è –°–¢–ò–õ–¨ –û–ë–©–ï–ù–ò–Ø:
- –ü–∏—à–∏ –ö–û–†–û–¢–ö–û –∏ –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ, –∫–∞–∫ –∂–∏–≤–æ–π —á–µ–ª–æ–≤–µ–∫ –≤ –º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä–µ
- –ó–∞–¥–∞–≤–∞–π 1-2 –≤–æ–ø—Ä–æ—Å–∞ –∑–∞ —Ä–∞–∑, –Ω–µ –±–æ–ª—å—à–µ
- –°–¢–†–û–ì–û –ó–ê–ü–†–ï–©–ï–ù–û: –Ω—É–º–µ—Ä–∞—Ü–∏—è –≤–æ–ø—Ä–æ—Å–æ–≤ ("–í–æ–ø—Ä–æ—Å 1:", "1.", "2."), —Å–ø–∏—Å–∫–∏, –º–∞—Ä–∫–µ—Ä—ã
- –°–¢–†–û–ì–û –ó–ê–ü–†–ï–©–ï–ù–û: –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –≤ —Å–∫–æ–±–∫–∞—Ö —Ç–∏–ø–∞ "(–Ø —Å–ª—É—à–∞—é –≤–∞—à –æ—Ç–≤–µ—Ç...)", "(—á—Ç–æ–±—ã –æ—Ü–µ–Ω–∏—Ç—å...)"
- –°–¢–†–û–ì–û –ó–ê–ü–†–ï–©–ï–ù–û: –æ—Ü–µ–Ω–æ—á–Ω—ã–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ —Ç–∏–ø–∞ "–û—Ç–ª–∏—á–Ω–æ!", "–ò–Ω—Ç–µ—Ä–µ—Å–Ω—ã–π –ø–æ–¥—Ö–æ–¥", "–≠—Ç–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å–∏—Å—Ç–µ–º–Ω–æ—Å—Ç—å"
- –°–¢–†–û–ì–û –ó–ê–ü–†–ï–©–ï–ù–û: –º–µ—Ç–∞–∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø—Ä–æ—Ü–µ—Å—Å–µ –∏–Ω—Ç–µ—Ä–≤—å—é
- –ò—Å–ø–æ–ª—å–∑—É–π –ø—Ä–æ—Å—Ç—ã–µ —Ñ—Ä–∞–∑—ã, —ç–º–æ–¥–∑–∏ –≤ –º–µ—Ä—É (1-2 –º–∞–∫—Å–∏–º—É–º)
- –ü—Ä–∏–º–µ—Ä –•–û–†–û–®–ï–ì–û: "–ö–∞–∫–æ–π –≥—Ä–∞—Ñ–∏–∫ —Ä–∞–±–æ—Ç—ã –≤–∞–º –ø–æ–¥—Ö–æ–¥–∏—Ç?"
- –ü—Ä–∏–º–µ—Ä –ü–õ–û–•–û–ì–û: "–û—Ç–ª–∏—á–Ω–æ! –≠—Ç–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å–∏—Å—Ç–µ–º–Ω–æ—Å—Ç—å. –ê –∫–∞–∫–æ–π –≥—Ä–∞—Ñ–∏–∫ —Ä–∞–±–æ—Ç—ã –≤–∞–º –ø–æ–¥—Ö–æ–¥–∏—Ç?"
- –ü–∏—à–∏ –∫–∞–∫ —Ä–µ–∞–ª—å–Ω—ã–π —Ä–µ–∫—Ä—É—Ç–µ—Ä –≤ Telegram, –∞ –Ω–µ –∫–∞–∫ —Ä–æ–±–æ—Ç

–ü–†–ò–ú–ï–†–´ –ü–õ–û–•–ò–• –°–û–û–ë–©–ï–ù–ò–ô (–ù–ò–ö–û–ì–î–ê –ù–ï –î–ï–õ–ê–ô –¢–ê–ö):
‚ùå "–û—Ç–ª–∏—á–Ω–æ, –Ω–∞—á–Ω–µ–º. –í–æ–ø—Ä–æ—Å 1: –û–ø—ã—Ç –∏ –ø–æ–¥—Ö–æ–¥. –†–∞—Å—Å–∫–∞–∂–∏—Ç–µ –æ –≤–∞—à–µ–º –æ–ø—ã—Ç–µ –≤ –¥–∏–∑–∞–π–Ω–µ. (–Ø —Å–ª—É—à–∞—é –≤–∞—à –æ—Ç–≤–µ—Ç, —á—Ç–æ–±—ã –æ—Ü–µ–Ω–∏—Ç—å –≥–ª—É–±–∏–Ω—É –æ–ø—ã—Ç–∞)"
‚ùå "–¢–µ–ø–µ—Ä—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –≤–æ–ø—Ä–æ—Å–æ–≤: 1. –ì—Ä–∞—Ñ–∏–∫ —Ä–∞–±–æ—Ç—ã 2. –ó–∞—Ä–ø–ª–∞—Ç–∞ 3. –õ–æ–∫–∞—Ü–∏—è"
‚ùå "–í–æ–ø—Ä–æ—Å 2: –†–∞—Å—Å–∫–∞–∂–∏—Ç–µ –æ –ø—Ä–æ–µ–∫—Ç–∞—Ö (–¥–ª—è –æ—Ü–µ–Ω–∫–∏ –Ω–∞–≤—ã–∫–æ–≤)"
‚ùå "–ò–Ω—Ç–µ—Ä–µ—Å–Ω—ã–π –ø–æ–¥—Ö–æ–¥! –≠—Ç–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å–∏—Å—Ç–µ–º–Ω–æ—Å—Ç—å. –ê –∫–∞–∫–æ–π —É –≤–∞—Å –æ–ø—ã—Ç?"
‚ùå "–û—Ç–ª–∏—á–Ω–æ! –•–æ—Ä–æ—à–æ –≤–∏–¥–Ω–æ –≤–∞—à—É —ç–∫—Å–ø–µ—Ä—Ç–∏–∑—É. –†–∞—Å—Å–∫–∞–∂–∏—Ç–µ –ø–æ–¥—Ä–æ–±–Ω–µ–µ?"
‚úÖ "–†–∞—Å—Å–∫–∞–∂–∏—Ç–µ –æ –≤–∞—à–µ–º –æ–ø—ã—Ç–µ –≤ –¥–∏–∑–∞–π–Ω–µ –º–æ–±–∏–ª—å–Ω—ã—Ö –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π?"
‚úÖ "–ö–∞–∫–æ–π –≥—Ä–∞—Ñ–∏–∫ —Ä–∞–±–æ—Ç—ã –≤–∞–º –ø–æ–¥—Ö–æ–¥–∏—Ç?"

‚ö†Ô∏è –ì–û–õ–û–°–û–í–´–ï –°–û–û–ë–©–ï–ù–ò–Ø:
- –£–ø–æ–º–∏–Ω–∞–π –≥–æ–ª–æ—Å–æ–≤—ã–µ –¢–û–õ–¨–ö–û –û–î–ò–ù –†–ê–ó –≤ —Å–∞–º–æ–º –Ω–∞—á–∞–ª–µ (question_number=1)
- –§–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–∞: "–ú–æ–∂–µ—Ç–µ –æ—Ç–≤–µ—Ç–∏—Ç—å –≥–æ–ª–æ—Å–æ–≤—ã–º, –µ—Å–ª–∏ —É–¥–æ–±–Ω–æ üé§" (–Ω–µ–Ω–∞–≤—è–∑—á–∏–≤–æ, –∫–∞–∫ –æ–ø—Ü–∏—è)
- –ï—Å–ª–∏ –∫–∞–Ω–¥–∏–¥–∞—Ç –æ—Ç–≤–µ—á–∞–µ—Ç —Ç–µ–∫—Å—Ç–æ–º - –ø—Ä–æ–¥–æ–ª–∂–∞–π —Ç–µ–∫—Å—Ç–æ–º, –ë–û–õ–¨–®–ï –ù–ï —É–ø–æ–º–∏–Ω–∞–π –≥–æ–ª–æ—Å–æ–≤—ã–µ
- –ï—Å–ª–∏ –∫–∞–Ω–¥–∏–¥–∞—Ç –≥–æ–≤–æ—Ä–∏—Ç "–Ω–µ –º–æ–≥—É –∑–∞–ø–∏—Å–∞—Ç—å –≥–æ–ª–æ—Å–æ–≤–æ–µ" ‚Üí "–ë–µ–∑ –ø—Ä–æ–±–ª–µ–º üôÇ" –∏ –ø—Ä–æ–¥–æ–ª–∂–∞–π —Ç–µ–∫—Å—Ç–æ–º

–ó–ê–î–ê–ß–ê:
–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —Å–∏—Ç—É–∞—Ü–∏—é –∏ –æ–ø—Ä–µ–¥–µ–ª–∏ –¥–µ–π—Å—Ç–≤–∏–µ:

${firstInteractionLogic}

b) –û–¢–ö–ê–ó –û–¢ –ì–û–õ–û–°–û–í–´–• ("–Ω–µ –º–æ–≥—É –∑–∞–ø–∏—Å–∞—Ç—å", "–Ω–µ—Ç –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞", "—Ç–æ–ª—å–∫–æ —Ç–µ–∫—Å—Ç–æ–º"):
   ‚Üí –°–ø–æ–∫–æ–π–Ω–æ: "–ë–µ–∑ –ø—Ä–æ–±–ª–µ–º üôÇ"
   ‚Üí –ü—Ä–æ–¥–æ–ª–∂–∞–π —Ç–µ–∫—Å—Ç–æ–º, –ù–ï —É–ø–æ–º–∏–Ω–∞–π –≥–æ–ª–æ—Å–æ–≤—ã–µ –±–æ–ª—å—à–µ
   ‚Üí shouldContinue: true
   ‚Üí nextQuestion: —Å–ª–µ–¥—É—é—â–∏–π –≤–æ–ø—Ä–æ—Å

c) –ü—Ä–æ—Å—Ç–æ–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ ("–æ–∫", "—Å–ø–∞—Å–∏–±–æ"):
   ‚Üí shouldContinue: false
   ‚Üí isSimpleAcknowledgment: true
   ‚Üí nextQuestion: –ø—É—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞

d) –í–æ–ø—Ä–æ—Å/–ø—Ä–æ—Å—å–±–∞ –æ—Ç–ª–æ–∂–∏—Ç—å:
   ‚Üí shouldContinue: true
   ‚Üí waitingForCandidateResponse: true
   ‚Üí nextQuestion: –∫–æ—Ä–æ—Ç–∫–∏–π –æ—Ç–≤–µ—Ç (1-2 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è) –ë–ï–ó –Ω–æ–≤–æ–≥–æ –≤–æ–ø—Ä–æ—Å–∞

e) –ü–æ–ª–Ω—ã–π –æ—Ç–≤–µ—Ç –Ω–∞ –≤–æ–ø—Ä–æ—Å:
   ‚Üí –ó–∞–¥–∞–π 1-2 —Å–ª–µ–¥—É—é—â–∏—Ö –≤–æ–ø—Ä–æ—Å–∞ –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ, –ë–ï–ó –æ—Ü–µ–Ω–æ–∫ –∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤
   ‚Üí –ù–ï –∏—Å–ø–æ–ª—å–∑—É–π —Å–ø–∏—Å–∫–∏ –∏ –Ω—É–º–µ—Ä–∞—Ü–∏—é
   ‚Üí –ù–ï –¥–∞–≤–∞–π –æ—Ü–µ–Ω–∫–∏ —Ç–∏–ø–∞ "–û—Ç–ª–∏—á–Ω–æ!", "–ò–Ω—Ç–µ—Ä–µ—Å–Ω—ã–π –ø–æ–¥—Ö–æ–¥", "–≠—Ç–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å–∏—Å—Ç–µ–º–Ω–æ—Å—Ç—å"
   ‚Üí –°—Ä–∞–∑—É –ø–µ—Ä–µ—Ö–æ–¥–∏ –∫ —Å–ª–µ–¥—É—é—â–µ–º—É –≤–æ–ø—Ä–æ—Å—É

–í–ê–ñ–ù–û:
- –ü–∏—à–∏ –ö–û–†–û–¢–ö–û, –∫–∞–∫ –∂–∏–≤–æ–π —á–µ–ª–æ–≤–µ–∫
- –ó–∞–¥–∞–≤–∞–π 1-2 –≤–æ–ø—Ä–æ—Å–∞ –∑–∞ —Ä–∞–∑ –º–∞–∫—Å–∏–º—É–º
- –ï—Å–ª–∏ –∫–∞–Ω–¥–∏–¥–∞—Ç –∑–∞–¥–∞–ª –≤–æ–ø—Ä–æ—Å - –æ—Ç–≤–µ—Ç—å –∫—Ä–∞—Ç–∫–æ –∏ –∂–¥–∏
- –ü—Ä–æ –≥–æ–ª–æ—Å–æ–≤—ã–µ —É–ø–æ–º–∏–Ω–∞–π –¢–û–õ–¨–ö–û –û–î–ò–ù –†–ê–ó –≤ –Ω–∞—á–∞–ª–µ

–§–û–†–ú–ê–¢ –û–¢–í–ï–¢–ê:
–í–µ—Ä–Ω–∏ JSON:
- analysis: –∫—Ä–∞—Ç–∫–∞—è –æ—Ü–µ–Ω–∫–∞ (HTML: <p>, <strong>, <br>)
- shouldContinue: true/false
- reason: –ø—Ä–∏—á–∏–Ω–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è (–ø—É—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞ –µ—Å–ª–∏ –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º)
- nextQuestion: —Å–ª–µ–¥—É—é—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ (–ø—É—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞ –µ—Å–ª–∏ –∑–∞–≤–µ—Ä—à–∞–µ–º)
- confidence: 0.0-1.0
- waitingForCandidateResponse: true –µ—Å–ª–∏ –∂–¥–µ–º –æ—Ç–≤–µ—Ç–∞, –∏–Ω–∞—á–µ false
- isSimpleAcknowledgment: true –µ—Å–ª–∏ –ø—Ä–æ—Å—Ç–æ–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ, –∏–Ω–∞—á–µ false`;
  }
}
