# Реализация безопасности для TRPC эндпоинтов интервью

## Overview
Этот документ описывает улучшения безопасности, реализованные для TRPC эндпоинтов интервью, чтобы предотвратить несанкционированный доступ к конфиденциальным данным.

## Changes Made

### 1. Утилита валидации токенов (`packages/api/src/utils/interview-token-validator.ts`)

Создана комплексная утилита валидации токенов со следующими функциями:

- **`validateInterviewToken()`**: Валидирует токены интервью как из ссылок вакансий, так и из ссылок гиг-интервью, проверяя:
  - Существование и формат токена
  - Активный статус токена
  - Дату истечения токена
  - Возвращает валидированную информацию о токене, включая тип (vacancy/gig) и ID сущности

- **`hasVacancyAccess()`**: Проверяет, имеет ли валидированный токен доступ к конкретной вакансии

- **`hasGigAccess()`**: Проверяет, имеет ли валидированный токен доступ к конкретному гигу

- **`hasConversationAccess()`**: Комплексная проверка доступа к беседам с поддержкой:
  - Доступа на основе токена (участники интервью)
  - Доступа на основе пользователя (члены workspace)
  - Валидации через отклики vacancy/gig и членство в workspace

- **`extractTokenFromHeaders()`**: Извлекает токены из HTTP заголовков с поддержкой:
  - Заголовка `Authorization: Bearer <token>`
  - Пользовательского заголовка `x-interview-token: <token>`

- **`requireConversationAccess()`**: Вспомогательная middleware-функция, которая выбрасывает TRPC ошибки при отказе в доступе

### 2. Улучшение TRPC контекста (`packages/api/src/trpc.ts`)

Обновлена функция createTRPCContext для:
- Извлечения токенов интервью из заголовков запроса
- Автоматической валидации токенов при создании контекста
- Добавления `interviewToken` в контекст (nullable)
- Корректной обработки ошибок валидации токенов без блокировки запросов

Добавлен новый тип процедуры:
- **`interviewTokenProcedure`**: Требует валидный токен интервью, аналогично `protectedProcedure`, но для участников интервью

### 3. Роут приложения интервью (`apps/interview/src/app/api/trpc/[trpc]/route.ts`)

Исправлена уязвимость безопасности:
- Изменено с `auth: null` на `auth` (правильный экземпляр auth)
- Теперь корректно валидирует как пользовательские сессии, так и токены интервью

### 4. Защищенные эндпоинты

#### `checkDuplicateResponse`
- Требует либо валидный токен интервью для вакансии, либо аутентифицированного пользователя с доступом к workspace
- Валидирует членство в workspace для аутентифицированных пользователей
- Предотвращает несанкционированную проверку дубликатов

#### `getChatHistory`
- Требует доступ к беседе через токен или аутентификацию пользователя
- Валидирует принадлежность токена к беседе
- Валидирует членство в workspace для аутентифицированных пользователей
- Логирует доступ для целей аудита

#### `getInterviewContext`
- Требует доступ к беседе через токен или аутентификацию пользователя
- Валидирует принадлежность токена к беседе
- Валидирует членство в workspace для аутентифицированных пользователей
- Возвращает контекст вакансии или гига только при наличии авторизации

#### `sendChatMessage`
- Требует доступ к беседе через токен или аутентификацию пользователя
- Валидирует принадлежность токена к беседе
- Валидирует членство в workspace для аутентифицированных пользователей
- Проверяет, что беседа активна перед принятием сообщений

## Security Model

### Уровни доступа

1. **Участник интервью (на основе токена)**:
   - Имеет валидный токен интервью из ссылки
   - Может получить доступ только к своей беседе
   - Может просматривать историю чата, контекст интервью и отправлять сообщения
   - Не может проверять дубликаты для других вакансий

2. **Член workspace (на основе пользователя)**:
   - Аутентифицированный пользователь с членством в workspace
   - Может получить доступ ко всем беседам в своем workspace
   - Может проверять дубликаты для вакансий в своем workspace
   - Полный доступ к данным интервью для своего workspace

3. **Публичный (без доступа)**:
   - Не может получить доступ к конфиденциальным эндпоинтам
   - Получает ошибки 401 UNAUTHORIZED или 403 FORBIDDEN

### Поток токена

```
1. Пользователь получает ссылку на интервью с токеном
2. Frontend включает токен в запросы через:
   - Заголовок Authorization: Bearer <token>, ИЛИ
   - Заголовок x-interview-token: <token>
3. TRPC контекст извлекает и валидирует токен
4. Эндпоинты проверяют доступ с помощью requireConversationAccess()
5. Доступ предоставляется, если токен соответствует vacancy/gig беседы
```

### Поток пользователя

```
1. Пользователь аутентифицируется через better-auth
2. Сессия валидируется в TRPC контексте
3. Эндпоинты проверяют членство в workspace
4. Доступ предоставляется, если пользователь является членом workspace беседы
```

## Implementation Notes

- Вся валидация происходит на уровне процедуры перед бизнес-логикой
- Валидация токена неблокирующая (ошибки логируются, но не приводят к сбою запросов)
- Членство в workspace проверяется через запросы к базе данных
- Включено логирование аудита для доступа аутентифицированных пользователей
- Non-null утверждения используются безопасно после null-проверок (ожидаются предупреждения TypeScript)

## Testing Recommendations

1. **Доступ на основе токена**:
   - Валидный токен может получить доступ к своей беседе
   - Истекший токен отклоняется
   - Невалидный токен отклоняется
   - Токен для вакансии A не может получить доступ к беседе вакансии B

2. **Доступ на основе пользователя**:
   - Член workspace может получить доступ к беседам workspace
   - Не-член не может получить доступ к беседам workspace
   - Пользователь без токена не может проверять дубликаты

3. **Граничные случаи**:
   - Отсутствующие заголовки возвращают 401
   - Некорректные токены возвращают 401
   - Беседа не найдена возвращает 404
   - Неактивная беседа отклоняет сообщения

## Migration Path

Миграции базы данных не требуются. Изменения являются чисто улучшениями безопасности на уровне приложения.

## Future Improvements

1. Ограничение частоты запросов для токена/пользователя
2. Механизм обновления токенов
3. Разрешения на уровне беседы (только чтение vs чтение-запись)
4. Ограничения доступа на основе IP
5. Аналитика использования токенов
