# Implementation Plan: Resolve Circular Dependency

## Overview

Исправление race condition в функции обновления метаданных разговора путем добавления оптимистичной блокировки с использованием поля версии.

## Tasks

- [ ] 1. Добавить поле metadata_version в схему conversation
  - Добавить колонку `metadata_version` типа integer с default значением 1
  - Убедиться что поле not null
  - _Requirements: 5.1, 5.2_

- [ ] 2. Реализовать функцию updateWithOptimisticLock
  - [ ] 2.1 Создать внутреннюю функцию для одной попытки обновления
    - Использовать транзакцию для атомарности
    - SELECT текущих метаданных и версии
    - Merge данных внутри транзакции
    - UPDATE с проверкой версии в WHERE
    - Инкремент версии при успехе
    - _Requirements: 1.2, 1.4, 5.3_
  
  - [ ]* 2.2 Написать unit тест для updateWithOptimisticLock
    - Тест успешного обновления
    - Тест конфликта версий
    - _Requirements: 1.2, 5.3_

- [ ] 3. Обновить функцию updateConversationMetadata
  - [ ] 3.1 Добавить параметр options с maxRetries
    - Значение по умолчанию: 3 попытки
    - Сохранить обратную совместимость (опциональный параметр)
    - _Requirements: 3.1, 4.1, 4.3_
  
  - [ ] 3.2 Реализовать retry логику
    - Цикл с максимальным количеством попыток
    - Вызов updateWithOptimisticLock
    - Логирование конфликтов версий
    - Возврат false при превышении лимита
    - _Requirements: 2.3, 4.2, 4.4_
  
  - [ ]* 3.3 Написать unit тесты для retry логики
    - Тест успешного обновления с первой попытки
    - Тест успешного обновления после конфликта
    - Тест превышения лимита попыток
    - _Requirements: 2.3, 4.2_

- [ ] 4. Checkpoint - Убедиться что все тесты проходят
  - Ensure all tests pass, ask the user if questions arise.

- [ ]* 5. Написать property-based тесты
  - [ ]* 5.1 Property test для конкурентных обновлений
    - **Property 1: Атомарность обновлений**
    - **Validates: Requirements 1.1**
    - Генерировать случайные пары обновлений
    - Выполнять конкурентно
    - Проверять что оба обновления сохранены
  
  - [ ]* 5.2 Property test для консистентности версий
    - **Property 2: Консистентность версий**
    - **Validates: Requirements 5.3**
    - Генерировать N последовательных обновлений
    - Проверять что версия увеличилась на N
  
  - [ ]* 5.3 Property test для retry механизма
    - **Property 3: Идемпотентность при конфликтах**
    - **Validates: Requirements 2.3**
    - Симулировать конфликты версий
    - Проверять корректность повторных попыток

- [ ] 6. Обновить документацию функции
  - Добавить описание нового параметра options
  - Описать поведение при конфликтах
  - Добавить примеры использования
  - _Requirements: 3.1, 4.1_

- [ ] 7. Final checkpoint - Убедиться что все тесты проходят
  - Ensure all tests pass, ask the user if questions arise.

## Notes

- Задачи, помеченные `*`, являются опциональными и могут быть пропущены для быстрого MVP
- Каждая задача ссылается на конкретные требования для отслеживаемости
- Checkpoints обеспечивают инкрементальную валидацию
- Property тесты валидируют универсальные свойства корректности
- Unit тесты валидируют конкретные примеры и граничные случаи
