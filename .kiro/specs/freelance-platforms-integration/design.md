# Документ проектирования: Интеграция фриланс-платформ

## Обзор

Интеграция фриланс-платформ расширяет платформу автоматизации рекрутинга QBS для поддержки множества фриланс-площадок (Kwork.ru, FL.ru, Weblancer.net, Upwork и др.). В отличие от интеграции с HeadHunter, которая использует официальные API, фриланс-платформы обычно не имеют публичных API, что требует гибридного подхода: работодатели вручную распространяют ссылки на AI-интервью и опционально импортируют отклики фрилансеров для автоматизированного анализа.

Система предоставляет три основных потока ценности:
1. **Распространение ссылок на интервью**: Генерация уникальных ссылок для каждого задания, которыми работодатели делятся на любой фриланс-платформе
2. **Ручной импорт откликов**: Возможность для работодателей копировать и вставлять отклики фрилансеров с любой платформы для AI-анализа
3. **AI-скрининг**: Анализ откликов и проведение интервью для генерации шортлистов

Этот дизайн использует существующую инфраструктуру QBS (tRPC API, Inngest jobs, AI-анализ), добавляя платформо-независимые компоненты, работающие с любой фриланс-площадкой.

## Архитектура

### Компоненты системы

```
┌─────────────────────────────────────────────────────────────┐
│                      Фронтенд (Next.js)                      │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │  Управление  │  │   Ручной     │  │  Просмотр    │      │
│  │  заданиями   │  │   импорт     │  │  шортлиста   │      │
│  └──────────────┘  └──────────────┘  └──────────────┘      │
└─────────────────────────────────────────────────────────────┘
                            │ tRPC
┌─────────────────────────────────────────────────────────────┐
│                      Бэкенд (tRPC API)                       │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │   Роутер     │  │   Парсер     │  │  Генератор   │      │
│  │  фриланс-    │  │   откликов   │  │   ссылок     │      │
│  │  платформ    │  │              │  │  интервью    │      │
│  └──────────────┘  └──────────────┘  └──────────────┘      │
└─────────────────────────────────────────────────────────────┘
                            │
┌─────────────────────────────────────────────────────────────┐
│                    База данных (PostgreSQL)                  │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │  vacancies   │  │   vacancy_   │  │  interview_  │      │
│  │ (source:     │  │  responses   │  │    links     │      │
│  │  kwork/fl/   │  └──────────────┘  └──────────────┘      │
│  │  weblancer)  │                                            │
│  └──────────────┘                                            │
└─────────────────────────────────────────────────────────────┘
                            │
┌─────────────────────────────────────────────────────────────┐
│              Фоновые задачи (Inngest)                        │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │  AI-анализ   │  │  Проведение  │  │  Генерация   │      │
│  │   откликов   │  │   интервью   │  │  шортлиста   │      │
│  └──────────────┘  └──────────────┘  └──────────────┘      │
└─────────────────────────────────────────────────────────────┘
                            │
┌─────────────────────────────────────────────────────────────┐
│              Публичный портал интервью                       │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │  Целевая     │  │  Интерфейс   │  │  Страница    │      │
│  │  страница    │  │  интервью    │  │  завершения  │      │
│  └──────────────┘  └──────────────┘  └──────────────┘      │
└─────────────────────────────────────────────────────────────┘
```

### Интеграция с существующей системой

Интеграция фриланс-платформ переиспользует существующую инфраструктуру:

- **Таблица Vacancy**: Добавление источников платформ: `"kwork"`, `"fl"`, `"weblancer"`, `"upwork"` и т.д.
- **Таблица Response**: Хранение откликов фрилансеров с использованием существующей схемы
- **AI-анализ**: Использование существующей логики скрининга и интервью на GPT-4
- **Telegram**: Опциональное использование существующей интеграции с Telegram для уведомлений

Новые компоненты:
- **Таблица Interview Links**: Хранение уникальных URL интервью для каждого задания
- **Парсер откликов**: Извлечение структурированных данных из вставленного текста (платформо-независимый)
- **Публичный портал интервью**: Отдельные Next.js страницы для фрилансеров
- **Конфигурация платформ**: Хранение специфичных для платформы настроек (URL-паттерны, маппинг полей)

## Компоненты и интерфейсы

### 1. Генератор ссылок на интервью

**Назначение**: Создание уникальных, безопасных ссылок на интервью для каждого задания на фриланс-платформе.

**Интерфейс**:
```typescript
interface InterviewLinkGenerator {
  generateLink(vacancyId: string): Promise<InterviewLink>;
  validateLink(token: string): Promise<InterviewLink | null>;
  deactivateLink(linkId: string): Promise<void>;
}

interface InterviewLink {
  id: string;
  vacancyId: string;
  token: string; // UUID для URL
  url: string; // Полный публичный URL
  isActive: boolean;
  createdAt: Date;
  expiresAt: Date | null;
}
```

**Детали реализации**:
- Генерация криптографически безопасных токенов с использованием `crypto.randomUUID()`
- Хранение ссылок в таблице `interview_links` с внешним ключом на `vacancies`
- Формат URL: `https://qbs.app/interview/{token}`
- Ссылки остаются активными до закрытия задания или ручной деактивации
- Ограничение скорости генерации ссылок для предотвращения злоупотреблений (макс. 1 на вакансию)

### 2. Парсер откликов

**Назначение**: Извлечение структурированных данных из вставленного текста откликов с фриланс-платформ.

**Интерфейс**:
```typescript
interface ResponseParser {
  parseSingle(text: string): ParsedResponse;
  parseBulk(text: string): ParsedResponse[];
  validateParsedData(data: ParsedResponse): ValidationResult;
}

interface ParsedResponse {
  freelancerName: string | null;
  contactInfo: {
    email?: string;
    phone?: string;
    telegram?: string;
    platformProfile?: string;
  };
  responseText: string;
  confidence: number; // Оценка точности парсинга 0-1
}

interface ValidationResult {
  isValid: boolean;
  errors: string[];
  warnings: string[];
}
```

**Детали реализации**:
- Использование regex-паттернов для извлечения email, телефонов, Telegram username
- Определение URL профилей платформ с настраиваемыми паттернами:
  - Kwork: `kwork.ru/user/...`
  - FL.ru: `fl.ru/users/...`
  - Weblancer: `weblancer.net/users/...`
- Для массового парсинга разделение по общим разделителям (двойные переносы строк, "---" и т.д.)
- Использование OpenAI GPT-4 как запасного варианта для неоднозначного текста
- Возврат оценки уверенности на основе количества успешно извлечённых полей

### 3. UI ручного импорта

**Назначение**: Позволить работодателям вставлять и импортировать отклики фрилансеров.

**Интерфейс**:
```typescript
interface ManualImportForm {
  mode: 'single' | 'bulk';
  vacancyId: string;
  rawText: string;
  parsedData: ParsedResponse[];
  onParse: () => void;
  onEdit: (index: number, data: ParsedResponse) => void;
  onSubmit: () => Promise<void>;
}
```

**Поток UI**:
1. Работодатель выбирает задание
2. Выбирает режим одиночного или массового импорта
3. Вставляет текст с фриланс-платформы (Kwork, FL.ru, Weblancer и т.д.)
4. Система автоматически парсит и отображает предпросмотр
5. Работодатель проверяет/редактирует распарсенные данные
6. Подтверждает импорт
7. Система создаёт записи `vacancy_responses`

**Валидация**:
- Требуется как минимум имя ИЛИ контактная информация
- Предотвращение дублирования импорта (проверка по URL профиля платформы или имя+вакансия)
- Показ предупреждений для парсинга с низкой уверенностью

### 4. AI-анализатор откликов

**Назначение**: Анализ импортированных откликов с использованием GPT-4 для оценки фрилансеров.

**Интерфейс**:
```typescript
interface ResponseAnalyzer {
  analyzeResponse(
    response: VacancyResponse,
    requirements: VacancyRequirements
  ): Promise<AnalysisResult>;
  
  batchAnalyze(
    responses: VacancyResponse[],
    requirements: VacancyRequirements
  ): Promise<AnalysisResult[]>;
}

interface AnalysisResult {
  responseId: string;
  score: number; // 0-100
  strengths: string[];
  weaknesses: string[];
  keySkills: string[];
  experienceYears: number | null;
  recommendation: 'INVITE' | 'MAYBE' | 'REJECT';
  reasoning: string;
}
```

**Детали реализации**:
- Переиспользование существующей Inngest-задачи `screenResume`
- Адаптация промпта для анализа текста отклика вместо PDF резюме
- Извлечение навыков, опыта и квалификации из отклика
- Сравнение с требованиями задания
- Хранение результатов в таблице `vacancy_screenings`

### 5. Целевая страница ссылки на интервью

**Назначение**: Публичная страница, где фрилансеры начинают AI-интервью.

**Маршрут**: `/interview/[token]`

**Компоненты**:
- **Заголовок**: Брендинг QBS, название задания
- **Инструкции**: Объяснение процесса интервью, примерное время (10-15 мин)
- **Форма информации о фрилансере**: Сбор имени, email, телефона, профиля на платформе
- **Кнопка старта**: Начать интервью

**Валидация**:
- Проверка, что токен действителен и активен
- Проверка, что задание всё ещё открыто
- Предотвращение дублирования интервью (проверка по email или профилю на платформе)

### 6. Проводник интервью (Веб-чат)

**Назначение**: Проведение AI-интервью с фрилансерами через веб-чат в реальном времени с буферизацией сообщений.

**Архитектура**:
Система переиспользует существующую логику интервью из Telegram-интеграции, включая **критически важную буферизацию сообщений**:
- Те же Inngest события: `freelance.interview.analyze`, `freelance.interview.send-question`, `freelance.interview.complete`
- Та же таблица `conversations`, `conversation_messages` и `buffered_messages`
- Те же AI-агенты для анализа и генерации вопросов
- Та же система буферизации с debounce для группировки быстрых сообщений
- Новый транспорт: вместо Telegram API используется tRPC subscriptions или Server-Sent Events (SSE)

**Зачем нужна буферизация**:
1. **Экономия токенов AI**: Группировка нескольких быстрых сообщений в один запрос к GPT-4
2. **Естественный диалог**: Фрилансер может отправить несколько коротких сообщений подряд ("Да", "Конечно", "Работал с React")
3. **Защита от спама**: Предотвращение множественных параллельных запросов к AI
4. **Улучшенный контекст**: AI видит полный ответ фрилансера, а не фрагменты

**Интерфейс**:
```typescript
interface FreelancerInfo {
  name: string;
  email: string;
  phone?: string;
  platformProfileUrl: string; // Обязательно! URL профиля на kwork.ru, fl.ru и т.д.
  telegram?: string;
}

interface InterviewConductor {
  // Начать интервью
  startInterview(
    vacancyId: string,
    freelancerInfo: FreelancerInfo
  ): Promise<Interview>;
  
  // Отправить сообщение от фрилансера (добавляется в буфер)
  sendMessage(
    conversationId: string,
    message: string
  ): Promise<void>;
  
  // Подписка на сообщения от бота (real-time)
  subscribeToMessages(
    conversationId: string
  ): AsyncIterator<ChatMessage>;
  
  // Получить историю чата
  getConversationHistory(
    conversationId: string
  ): Promise<ChatMessage[]>;
  
  // Получить статус интервью
  getInterviewStatus(
    conversationId: string
  ): Promise<InterviewStatus>;
}

interface Interview {
  conversationId: string;
  vacancyId: string;
  status: 'IN_PROGRESS' | 'COMPLETED' | 'ABANDONED';
  startedAt: Date;
}

interface ChatMessage {
  id: string;
  conversationId: string;
  sender: 'CANDIDATE' | 'BOT';
  content: string;
  contentType: 'TEXT';
  createdAt: Date;
}

interface InterviewStatus {
  status: 'IN_PROGRESS' | 'COMPLETED' | 'ABANDONED';
  questionNumber: number;
  score?: number;
  detailedScore?: number;
  analysis?: string;
}
```

**Поток работы с буферизацией**:

1. **Начало интервью**:
   - Фрилансер заполняет форму на целевой странице
   - Система создаёт `conversation` и `vacancy_response`
   - Отправляется первое приветственное сообщение от бота
   - Фрилансер перенаправляется на страницу чата

2. **Отправка сообщения фрилансером**:
   - Сообщение сохраняется в `conversation_messages` (sender: CANDIDATE)
   - Сообщение добавляется в буфер (`buffered_messages`)
   - Запускается событие `interview/buffer.debounce` с задержкой 3 секунды
   - UI показывает индикатор "обрабатывается..."

3. **Debounce и группировка**:
   - Если фрилансер отправляет ещё сообщения в течение 3 секунд, они добавляются в буфер
   - Таймер debounce сбрасывается при каждом новом сообщении
   - После 3 секунд тишины запускается событие `interview/buffer.flush`

4. **Обработка буфера** (событие `interview/buffer.flush`):
   - Извлекаются все сообщения из буфера для текущего `interviewStep`
   - Сообщения агрегируются в один текст (разделитель: `\n\n`)
   - Агрегированный текст отправляется в AI для анализа
   - AI генерирует следующий вопрос на основе всех сообщений
   - Буфер очищается

5. **Отправка ответа бота**:
   - Запускается событие `interview/send-question`
   - Вопрос сохраняется в `conversation_messages` (sender: BOT)
   - Вопрос отправляется фрилансеру через SSE/WebSocket
   - UI скрывает индикатор "обрабатывается..."

6. **Завершение интервью**:
   - AI определяет, что собрано достаточно информации
   - Запускается событие `interview/complete`
   - Создаётся скоринг в `interview_scoring` (переименовать из `telegram_interview_scoring`)
   - Обновляется статус `vacancy_response` на COMPLETED
   - Отправляется финальное сообщение фрилансеру

**Детали реализации**:

**Буферизация**:
- Использовать существующий `PostgresMessageBufferService`
- Таблица `buffered_messages` с полями: messageId, conversationId, userId, interviewStep, content, contentType, timestamp
- Debounce timeout: 3 секунды (настраиваемо через env: `INTERVIEW_BUFFER_DEBOUNCE_MS`)
- Каждое сообщение в отдельной строке для предотвращения затирания при конкурентных операциях

**Real-time коммуникация**:
- Использовать tRPC subscriptions или Server-Sent Events (SSE) для отправки сообщений от бота
- Polling как fallback для старых браузеров
- WebSocket для будущей поддержки голосовых сообщений

**Переиспользование логики**:
- Сервисы `analyzeAndGenerateNextQuestion`, `createInterviewScoring` из `packages/jobs/src/services/interview`
- Inngest функции: `bufferDebounceFunction`, `bufferFlushFunction`, `sendNextQuestionFunction`, `completeInterviewFunction`
- Адаптировать события: `telegram/interview.*` → `freelance/interview.*`
- Использовать `messageBufferService` для буферизации

**Отличия от Telegram**:
- Нет голосовых сообщений (пока)
- Нет транскрибации
- Нет задержек для имитации печатания (опционально)
- Прямая отправка через SSE вместо Telegram API
- Та же буферизация и debounce логика

**Хранение данных**:
- Та же таблица `conversations` (добавить поле `source: 'TELEGRAM' | 'WEB'`)
- Та же таблица `conversation_messages`
- Та же таблица `buffered_messages`
- Переименовать `telegram_interview_scoring` → `interview_scoring` (универсальная)

**UI чата**:
- Компонент списка сообщений с автопрокруткой
- Поле ввода текста с кнопкой отправки
- Индикатор "обрабатывается..." при буферизации (показывать после отправки сообщения)
- Индикатор "бот печатает..." при получении ответа от AI
- Отображение истории сообщений
- Адаптивный дизайн для мобильных устройств
- Отключение ввода во время обработки (опционально)

### 7. Генератор шортлиста

**Назначение**: Ранжирование фрилансеров и генерация шортлиста для работодателей.

**Интерфейс**:
```typescript
interface ShortlistGenerator {
  generateShortlist(
    vacancyId: string,
    options: ShortlistOptions
  ): Promise<Shortlist>;
}

interface ShortlistOptions {
  minScore?: number; // По умолчанию: 60
  maxCandidates?: number; // По умолчанию: 10
  sortBy: 'SCORE' | 'EXPERIENCE' | 'RESPONSE_DATE';
}

interface Shortlist {
  vacancyId: string;
  candidates: ShortlistCandidate[];
  generatedAt: Date;
}

interface ShortlistCandidate {
  responseId: string;
  name: string;
  contactInfo: ContactInfo;
  overallScore: number;
  responseScore: number;
  interviewScore: number | null;
  keyHighlights: string[];
  redFlags: string[];
}
```

**Детали реализации**:
- Комбинирование оценки анализа отклика + оценки интервью (если завершено)
- Веса: 40% анализ отклика, 60% интервью (если доступно)
- Если нет интервью: использование только оценки анализа отклика
- Сортировка по комбинированной оценке по убыванию
- Фильтрация по минимальному порогу оценки
- Возврат топ N кандидатов

### 8. UI управления заданиями на фриланс-платформах

**Назначение**: Позволить работодателям создавать и управлять заданиями на фриланс-платформах.

**Типы вакансий**:
1. **Вакансии из HH.ru** - импортируются автоматически через API HeadHunter (существующая функциональность)
2. **Вакансии для фриланс-платформ** - создаются вручную работодателем для размещения на Kwork, FL.ru, Weblancer и т.д.

**Компоненты**:
- **Форма создания вакансии вручную**: 
  - Название вакансии
  - Описание (полное описание задачи)
  - Требования (навыки, опыт, квалификация)
  - Источник платформы (выбор: kwork, fl, weblancer, upwork, custom)
  - URL вакансии на платформе (опционально, если уже опубликована)
  - Автоматическая генерация ссылки на интервью при создании
- **Список вакансий**: Отображение всех вакансий (HH.ru + фриланс) со статистикой, фильтруемых по источнику
- **Страница деталей вакансии**: Показ ссылки на интервью, откликов (из всех источников), шортлиста
- **Дашборд статистики**: Отклики по источникам (HH.ru парсинг, ручной импорт, прямые переходы по ссылке), завершённые интервью, размер шортлиста

**Ключевые функции**:
- Создание вакансии вручную для любой фриланс-платформы
- Копирование ссылки на интервью в буфер обмена
- Скачивание шаблонного текста для описания вакансии (включает ссылку на интервью)
- Просмотр откликов из всех источников:
  - Спарсенные с HH.ru
  - Импортированные вручную
  - Пришедшие по ссылке `/interview/[token]`
- Запуск массового AI-анализа
- Экспорт шортлиста в CSV
- Фильтрация вакансий по источнику (HH.ru, Kwork, FL.ru, Weblancer и т.д.)

## Модели данных

### Новые таблицы

#### interview_links
```typescript
{
  id: uuid (PK),
  vacancyId: varchar(50) (FK -> vacancies.id),
  token: uuid (unique),
  isActive: boolean,
  createdAt: timestamp,
  expiresAt: timestamp | null
}
```

#### freelance_import_history
```typescript
{
  id: uuid (PK),
  vacancyId: varchar(50) (FK -> vacancies.id),
  importedBy: text (FK -> user.id),
  importMode: enum('SINGLE', 'BULK'),
  platformSource: varchar(50), // 'kwork', 'fl', 'weblancer' и т.д.
  rawText: text,
  parsedCount: integer,
  successCount: integer,
  failureCount: integer,
  createdAt: timestamp
}
```

#### platform_config (опционально, для будущей расширяемости)
```typescript
{
  id: uuid (PK),
  platformCode: varchar(50) (unique), // 'kwork', 'fl', 'weblancer'
  platformName: varchar(100), // 'Kwork.ru', 'FL.ru', 'Weblancer.net'
  profileUrlPattern: text, // Regex-паттерн для URL профилей
  isActive: boolean,
  createdAt: timestamp
}
```

### Модифицированные таблицы

#### vacancies
- Расширение enum `source` для включения: `"kwork"`, `"fl"`, `"weblancer"`, `"upwork"` и т.д.
- Существующие поля работают как есть для заданий на фриланс-платформах

#### vacancy_responses
- Добавление `platformProfileUrl: varchar(200)` для ссылки на профиль фрилансера (платформо-независимый)
- Добавление `importSource: enum('HH_API', 'FREELANCE_MANUAL', 'FREELANCE_LINK')` для отслеживания происхождения:
  - `HH_API` - отклик спарсен с HeadHunter через API
  - `FREELANCE_MANUAL` - отклик импортирован вручную работодателем
  - `FREELANCE_LINK` - фрилансер сам перешел по ссылке `/interview/[token]` и заполнил форму
- Существующие поля естественно маппятся:
  - `resumeId` -> ID профиля на платформе или сгенерированный UUID
  - `resumeUrl` -> URL профиля на платформе (для HH.ru) или `platformProfileUrl` (для фриланс-платформ)
  - `candidateName` -> Имя фрилансера
  - `coverLetter` -> Текст отклика с платформы (может быть пустым для `FREELANCE_LINK`, если фрилансер сразу начал интервью)

## Свойства корректности

*Свойство — это характеристика или поведение, которое должно быть истинным для всех допустимых выполнений системы — по сути, формальное утверждение о том, что система должна делать. Свойства служат мостом между человекочитаемыми спецификациями и машинно-проверяемыми гарантиями корректности.*


### Свойство 1: Уникальность ссылок на интервью
*Для любой* вакансии генерация ссылки на интервью должна создавать уникальный токен, который не использовался ни для какой другой вакансии.
**Проверяет: Требования 1.1**

### Свойство 2: Связь ссылки на интервью
*Для любой* сгенерированной ссылки на интервью запись ссылки должна ссылаться на правильный ID вакансии, для которой она была создана.
**Проверяет: Требования 1.2**

### Свойство 3: Валидность ссылки на основе статуса задания
*Для любой* вакансии, если вакансия активна, то её ссылка на интервью должна быть активной, а если вакансия закрыта, то её ссылка на интервью должна быть неактивной.
**Проверяет: Требования 1.3, 9.6**

### Свойство 4: Валидация ссылки
*Для любого* токена система должна корректно определять, является ли он действительным и активным, возвращая ошибку для недействительных или истёкших токенов.
**Проверяет: Требования 3.1, 3.2, 14.1**

### Свойство 5: Валидация обязательных полей
*Для любой* попытки импорта, если обязательные поля (имя или контактная информация) отсутствуют, импорт должен быть отклонён с соответствующими ошибками валидации.
**Проверяет: Требования 4.2, 4.3**

### Свойство 6: Связь импорта
*Для любого* успешно импортированного отклика созданная запись отклика должна ссылаться на указанный ID вакансии.
**Проверяет: Требования 4.4**

### Свойство 7: Сохранение текста отклика
*Для любого* импортированного отклика оригинальный текст отклика должен быть сохранён и доступен для извлечения из базы данных.
**Проверяет: Требования 4.5**

### Свойство 8: Предотвращение дубликатов
*Для любой* комбинации вакансия+фрилансер (идентифицируемой по URL профиля на платформе или имени), в системе должна существовать только одна запись отклика.
**Проверяет: Требования 4.6**

### Свойство 9: Парсинг множественных откликов
*Для любого* текста массового импорта, содержащего несколько откликов, парсер должен разделить его на отдельные записи откликов.
**Проверяет: Требования 5.2**

### Свойство 10: Извлечение контактной информации
*Для любого* текста отклика, содержащего email, телефон или Telegram username, парсер должен извлечь хотя бы одну форму контактной информации.
**Проверяет: Требования 5.3**

### Свойство 11: Пометка низкой уверенности
*Для любого* распарсенного отклика с оценкой уверенности ниже порога (например, 0.7), система должна пометить его для ручной проверки.
**Проверяет: Требования 5.4**

### Свойство 12: Отчётность массового импорта
*Для любой* операции массового импорта система должна сообщить количество успешных импортов и количество неудачных импортов с деталями ошибок.
**Проверяет: Требования 5.7**

### Свойство 13: Запуск анализа
*Для любого* успешно импортированного отклика задача AI-анализа должна быть автоматически поставлена в очередь в системе фоновых задач.
**Проверяет: Требования 6.1**

### Свойство 14: Анализ использует требования
*Для любого* AI-анализа требования задания из вакансии должны быть предоставлены в качестве входных данных функции анализа.
**Проверяет: Требования 6.2**

### Свойство 15: Структура выходных данных анализа
*Для любого* завершённого AI-анализа результат должен содержать извлечённые навыки, опыт, квалификацию и оценку совместимости.
**Проверяет: Требования 6.3**

### Свойство 16: Валидность диапазона оценки
*Для любого* AI-анализа или завершения интервью сгенерированная оценка должна быть в допустимом диапазоне от 0 до 100 включительно.
**Проверяет: Требования 6.4, 8.1**

### Свойство 17: Порог квалификации
*Для любого* проанализированного отклика, если оценка совместимости выше минимального порога, фрилансер должен быть помечен как квалифицированный для приглашения на интервью.
**Проверяет: Требования 7.1**

### Свойство 18: Генерация приглашения для квалифицированных кандидатов
*Для любого* квалифицированного фрилансера (оценка выше порога) должно быть сгенерировано персонализированное приглашение на интервью, содержащее ссылку на интервью и инструкции.
**Проверяет: Требования 7.2, 7.3**

### Свойство 19: Отслеживание приглашений
*Для любого* фрилансера, которому было отправлено приглашение на интервью, должна существовать запись, отслеживающая статус приглашения и временную метку.
**Проверяет: Требования 7.5**

### Свойство 20: Ранжирование шортлиста
*Для любого* набора фрилансеров с завершёнными интервью шортлист должен ранжировать их в порядке убывания по комбинированной оценке (анализ отклика + результаты интервью).
**Проверяет: Требования 8.2**

### Свойство 21: Фильтрация по порогу оценки
*Для любого* шортлиста с минимальным порогом оценки должны быть включены только фрилансеры с комбинированной оценкой больше или равной порогу.
**Проверяет: Требования 8.4**

### Свойство 22: Валидация создания задания
*Для любой* попытки создания задания система должна требовать предоставления полей: название задания, описание и требования.
**Проверяет: Требования 9.2**

### Свойство 23: Расчёт статистики
*Для любого* задания система должна рассчитывать и предоставлять статистику, включая общее количество откликов, завершённых интервью и размер шортлиста.
**Проверяет: Требования 9.4, 10.2**

### Свойство 24: Расчёт коэффициента конверсии
*Для любого* задания с откликами и интервью коэффициент конверсии (завершённые интервью / отправленные интервью) должен быть рассчитан корректно.
**Проверяет: Требования 10.3, 15.2**

### Свойство 25: Генерация оповещений о незавершённой работе
*Для любого* задания с откликами, ожидающими импорта или анализа, дашборд должен выделить его как требующее внимания.
**Проверяет: Требования 10.4**

### Свойство 26: Фильтрация дашборда
*Для любого* фильтра дашборда по диапазону дат или статусу задания должны отображаться только задания, соответствующие критериям фильтра.
**Проверяет: Требования 10.5**

### Свойство 27: Уведомление о завершении интервью
*Для любого* завершённого интервью уведомление должно быть отправлено работодателю, связанному с заданием.
**Проверяет: Требования 11.1**

### Свойство 28: Приоритетное уведомление о высокой оценке
*Для любого* кандидата с оценкой выше приоритетного порога (например, 85) приоритетное уведомление должно быть отправлено работодателю.
**Проверяет: Требования 11.2**

### Свойство 29: Группировка уведомлений
*Для любых* множественных событий уведомлений в пределах временного окна группировки (например, 5 минут) они должны быть объединены в одно сгруппированное уведомление.
**Проверяет: Требования 11.4**

### Свойство 30: Содержимое уведомления
*Для любого* уведомления, отправленного работодателю, оно должно включать прямую ссылку на соответствующий профиль фрилансера или результат интервью.
**Проверяет: Требования 11.5**

### Свойство 31: Логирование доступа к персональным данным
*Для любого* доступа к персональной информации фрилансера (имя, контакты, резюме) должна быть создана запись в журнале аудита с временной меткой и ID пользователя.
**Проверяет: Требования 12.5**

### Свойство 32: Детали ошибок массового импорта
*Для любого* массового импорта с одной или несколькими неудачами система должна предоставить конкретные сообщения об ошибках, указывающие, какие записи не удались и почему.
**Проверяет: Требования 14.3**

### Свойство 33: Уведомление о критической ошибке
*Для любой* критической системной ошибки (например, сбой AI-сервиса, потеря соединения с БД) автоматическое уведомление должно быть отправлено системным администраторам.
**Проверяет: Требования 14.5**

### Свойство 34: Отслеживание времени до шортлиста
*Для любого* задания, которое генерирует шортлист, система должна отслеживать и хранить время, прошедшее от создания задания до генерации шортлиста.
**Проверяет: Требования 15.1**

### Свойство 35: Расчёт распределения оценок
*Для любого* задания с несколькими кандидатами система должна рассчитывать распределение оценок (мин, макс, среднее, медиана, стандартное отклонение).
**Проверяет: Требования 15.3**

### Свойство 36: Сравнение метрик между платформами
*Для любого* workspace с заданиями с нескольких фриланс-платформ (Kwork, FL.ru, Weblancer и т.д.) система должна предоставлять сравнительные метрики (среднее время найма, коэффициенты завершения, качество откликов) между различными платформами.
**Проверяет: Требования 15.4**

### Свойство 37: Сравнение метрик между источниками
*Для любого* workspace с заданиями как с фриланс-платформ, так и с HeadHunter, система должна предоставлять сравнительные метрики между фриланс-платформами и интеграцией HeadHunter.
**Проверяет: Требования 15.5**

## Обработка ошибок

### Категории ошибок

1. **Ошибки валидации**: Недопустимые входные данные (отсутствующие поля, неправильно сформированные данные)
   - Возврат 400 Bad Request с конкретными ошибками полей
   - Отображение встроенных сообщений валидации в UI

2. **Ошибки аутентификации**: Недействительные или истёкшие ссылки на интервью
   - Возврат 401 Unauthorized для истёкших ссылок
   - Возврат 404 Not Found для несуществующих ссылок
   - Отображение понятной пользователю страницы ошибки с контактом поддержки

3. **Ошибки дубликатов**: Попытка импортировать одного и того же фрилансера дважды
   - Возврат 409 Conflict с ID существующего отклика
   - Предложение обновить существующий отклик вместо этого

4. **Ошибки AI-сервиса**: Сбои OpenAI API
   - Повтор с экспоненциальной задержкой (3 попытки)
   - Если все повторы не удались, пометить для ручной проверки
   - Отправить уведомление работодателю о сбое анализа

5. **Ошибки базы данных**: Сбои соединения, нарушения ограничений
   - Логирование деталей ошибки для отладки
   - Возврат 500 Internal Server Error клиенту
   - Отправка оповещения системным администраторам

### Стратегии восстановления после ошибок

- **Истечение ссылки на интервью**: Позволить работодателям перегенерировать ссылки для закрытых заданий
- **Неудачный AI-анализ**: Предоставить кнопку ручного повтора в UI
- **Частичный массовый импорт**: Сохранить успешные импорты, сообщить о неудачах, позволить повтор неудачных записей
- **Потеря прогресса интервью**: Автосохранение состояния интервью после каждого ответа, позволить возобновление с последнего вопроса

## Стратегия тестирования

### Модульное тестирование

Модульные тесты будут проверять конкретные примеры, граничные случаи и условия ошибок:

- **Генерация ссылок**: Тест, что токены являются валидными UUID и URL правильно сформированы
- **Граничные случаи парсера**: Пустой текст, неправильно сформированные email, отсутствующие имена
- **Расчёт оценок**: Граничные значения (0, 50, 100), взвешенные средние
- **Логика валидации**: Отсутствующие обязательные поля, недопустимые типы данных
- **Обработка ошибок**: Конкретные сценарии ошибок (истёкшая ссылка, дублирование импорта)

### Тестирование на основе свойств

Тесты свойств будут проверять универсальные свойства для всех входных данных с использованием **fast-check** (библиотека тестирования свойств для TypeScript). Каждый тест будет выполнять минимум 100 итераций с рандомизированными входными данными.

**Конфигурация тестов свойств**:
```typescript
import fc from 'fast-check';

// Пример структуры теста свойств
fc.assert(
  fc.property(
    fc.record({
      vacancyId: fc.uuid(),
      title: fc.string({ minLength: 1, maxLength: 500 }),
      // ... другие генераторы
    }),
    (vacancy) => {
      // Тест свойства здесь
    }
  ),
  { numRuns: 100 }
);
```

**Ключевые тесты свойств**:

1. **Уникальность ссылок** (Свойство 1): Генерация нескольких вакансий, проверка уникальности всех токенов
2. **Диапазон оценок** (Свойство 16): Генерация случайных результатов анализа, проверка оценок 0-100
3. **Предотвращение дубликатов** (Свойство 8): Генерация откликов с одинаковым фрилансером+вакансией, проверка сохранения только одного
4. **Порядок ранжирования** (Свойство 20): Генерация случайных оценок, проверка сортировки шортлиста по убыванию
5. **Логика фильтрации** (Свойства 21, 26): Генерация случайных данных, проверка корректной работы фильтров
6. **Расчёты метрик** (Свойства 23, 24, 35): Генерация случайных данных заданий, проверка точности расчётов

**Генераторы**:
- `vacancyGenerator`: Случайная вакансия с названием, требованиями, source="kwork/fl/weblancer"
- `responseGenerator`: Случайный отклик фрилансера с именем, контактами, текстом
- `scoreGenerator`: Случайное целое число 0-100
- `contactInfoGenerator`: Случайный email, телефон или Telegram username

**Теги тестов**: Каждый тест свойств будет включать комментарий, ссылающийся на свойство проектирования:
```typescript
// Функция: freelance-platforms-integration, Свойство 1: Уникальность ссылок на интервью
```

### Интеграционное тестирование

Интеграционные тесты будут проверять сквозные рабочие процессы:

- **Полный поток импорта**: Создать задание → импортировать отклик → запустить анализ → проверить сохранение результатов
- **Поток интервью**: Перейти по ссылке → отправить информацию → ответить на вопросы → проверить завершение
- **Генерация шортлиста**: Импортировать несколько откликов → завершить интервью → сгенерировать шортлист → проверить ранжирование
- **Поток уведомлений**: Завершить интервью → проверить отправку уведомления → проверить содержимое уведомления

### Чеклист ручного тестирования

- [ ] Мобильная адаптивность на iOS и Android
- [ ] Функциональность копирования в буфер обмена
- [ ] Массовый импорт с различными форматами текста
- [ ] Опыт интервью при медленном соединении
- [ ] Производительность дашборда с 100+ заданиями
- [ ] Форматирование экспорта в CSV/PDF

## Примечания по реализации

### Выбор технологий

- **Парсер**: Использование комбинации regex + GPT-4 для надёжного извлечения
- **UI интервью**: Серверный рендеринг Next.js страниц для SEO и производительности
- **Фоновые задачи**: Inngest для AI-анализа и уведомлений (существующая инфраструктура)
- **База данных**: PostgreSQL с Drizzle ORM (существующая инфраструктура)
- **Валидация**: Zod v4 схемы для всех входных данных

### Соображения производительности

- **Массовый импорт**: Обработка пакетами по 50 для избежания проблем с памятью
- **AI-анализ**: Постановка задач в очередь с ограничением скорости для соблюдения лимитов OpenAI API
- **Дашборд**: Кэширование статистики с TTL 5 минут
- **Ссылки на интервью**: Индекс на колонке token для быстрого поиска

### Соображения безопасности

- **Ссылки на интервью**: Использование криптографически безопасных случайных токенов (UUID v4)
- **Ограничение скорости**: Ограничение генерации ссылок на интервью до 10 в час на работодателя
- **Санитизация входных данных**: Санитизация всех пользовательских входных данных для предотвращения XSS
- **CORS**: Ограничение портала интервью конкретными доменами

### Будущие улучшения

- **Голосовые интервью**: Добавление поддержки голосовых ответов с использованием Whisper API
- **Автоматизированный скрапинг платформ**: Опциональная автоматизация браузера для получения откликов (рискованно, требует согласия пользователя)
- **Многоязычная поддержка**: Определение языка фрилансера и проведение интервью на их языке
- **Видео-интервью**: Добавление планирования видеозвонков для лучших кандидатов
- **Поддержка дополнительных платформ**: Лёгкое добавление новых фриланс-платформ через конфигурацию
- **Специфичные для платформы парсеры**: Оптимизированная логика парсинга для формата откликов каждой платформы
- **Интеграция API**: Когда платформы предоставляют API, бесшовный переход с ручного на автоматизированный импорт
